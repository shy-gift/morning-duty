<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë“±êµì§€ë„ êµì‚¬ ë°°ì •</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&family=Noto+Sans+KR:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --tiffany: #0ABAB5;
    --tiffany-light: #81D8D0;
    --tiffany-pale: #C8F0EE;
    --tiffany-deep: #007B78;
    --cream: #F8F6F2;
    --ivory: #FDFBF8;
    --charcoal: #2C2C2C;
    --mid-gray: #7A7A7A;
    --light-gray: #E8E8E8;
    --gold: #C9A84C;
    --gold-light: #E8D5A3;
    --white: #FFFFFF;
    --shadow: 0 4px 24px rgba(10,186,181,0.10);
    --shadow-deep: 0 8px 40px rgba(10,186,181,0.18);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background: var(--cream);
    color: var(--charcoal);
    font-family: 'Noto Sans KR', sans-serif;
    font-weight: 300;
    min-height: 100vh;
  }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    background: var(--tiffany);
    color: var(--white);
    padding: 28px 32px 24px;
    position: relative;
    overflow: hidden;
  }
  header::before {
    content: '';
    position: absolute;
    top: -40px; right: -60px;
    width: 240px; height: 240px;
    border-radius: 50%;
    background: rgba(255,255,255,0.07);
  }
  header::after {
    content: '';
    position: absolute;
    bottom: -60px; left: -30px;
    width: 160px; height: 160px;
    border-radius: 50%;
    background: rgba(255,255,255,0.05);
  }
  .header-title {
    font-family: 'Noto Sans KR', sans-serif;
    font-size: 22px;
    font-weight: 500;
    letter-spacing: 2px;
    margin-bottom: 0;
  }

  /* â”€â”€ INFO BOX â”€â”€ */
  .info-box {
    background: var(--ivory);
    border-left: 3px solid var(--tiffany);
    border-radius: 0 8px 8px 0;
    margin: 20px 20px 0;
    padding: 14px 16px;
    font-size: 12.5px;
    line-height: 1.9;
    color: var(--charcoal);
  }
  .info-box .info-title {
    font-weight: 500;
    color: var(--tiffany-deep);
    font-size: 13px;
    margin-bottom: 6px;
    letter-spacing: 0.5px;
  }

  /* â”€â”€ TABS â”€â”€ */
  .tabs {
    display: flex;
    background: var(--white);
    border-bottom: 1px solid var(--light-gray);
    margin: 20px 20px 0;
    border-radius: 12px 12px 0 0;
    overflow: hidden;
  }
  .tab {
    flex: 1;
    padding: 13px 8px;
    text-align: center;
    font-size: 12px;
    letter-spacing: 0.5px;
    font-weight: 400;
    color: var(--mid-gray);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }
  .tab.active {
    color: var(--tiffany-deep);
    border-bottom-color: var(--tiffany);
    font-weight: 500;
    background: var(--tiffany-pale);
  }

  /* â”€â”€ PANELS â”€â”€ */
  .panel {
    display: none;
    background: var(--white);
    margin: 0 20px 20px;
    border-radius: 0 0 12px 12px;
    padding: 20px;
    box-shadow: var(--shadow);
  }
  .panel.active { display: block; }

  /* â”€â”€ SECTION TITLE â”€â”€ */
  .section-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 18px;
    font-weight: 300;
    color: var(--tiffany-deep);
    letter-spacing: 1px;
    margin-bottom: 14px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--tiffany-pale);
  }

  /* â”€â”€ TEACHER LIST â”€â”€ */
  .teacher-input-row {
    display: flex; gap: 8px; margin-bottom: 10px;
  }
  .teacher-input-row input, .teacher-input-row select {
    flex: 1;
    padding: 9px 12px;
    border: 1px solid var(--light-gray);
    border-radius: 8px;
    font-family: 'Noto Sans KR', sans-serif;
    font-size: 13px;
    font-weight: 300;
    color: var(--charcoal);
    background: var(--ivory);
    outline: none;
    transition: border-color 0.2s;
  }
  .teacher-input-row input:focus,
  .teacher-input-row select:focus { border-color: var(--tiffany); }

  .btn {
    padding: 9px 16px;
    border: none;
    border-radius: 8px;
    font-family: 'Noto Sans KR', sans-serif;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.3px;
  }
  .btn-tiffany { background: var(--tiffany); color: var(--white); }
  .btn-tiffany:hover { background: var(--tiffany-deep); }
  .btn-outline { background: transparent; color: var(--tiffany); border: 1px solid var(--tiffany); }
  .btn-outline:hover { background: var(--tiffany-pale); }
  .btn-gold { background: var(--gold); color: var(--white); }
  .btn-gold:hover { background: #b0922e; }
  .btn-danger { background: #e05c5c; color: var(--white); }
  .btn-danger:hover { background: #c04040; }
  .btn-sm { padding: 5px 10px; font-size: 11px; }
  .btn-full { width: 100%; margin-top: 8px; }

  .teacher-list { margin-top: 10px; }
  .teacher-item {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 12px;
    background: var(--ivory);
    border-radius: 8px;
    margin-bottom: 6px;
    border: 1px solid var(--light-gray);
    font-size: 13px;
  }
  .teacher-name { flex: 1; font-weight: 400; }
  .teacher-name-edit {
    flex: 1;
    padding: 4px 8px;
    border: 1px solid var(--tiffany);
    border-radius: 6px;
    font-family: 'Noto Sans KR', sans-serif;
    font-size: 13px;
    font-weight: 400;
    color: var(--charcoal);
    background: var(--white);
    outline: none;
  }
  .bulk-area {
    width: 100%;
    min-height: 100px;
    padding: 10px 12px;
    border: 1px solid var(--light-gray);
    border-radius: 8px;
    font-family: 'Noto Sans KR', sans-serif;
    font-size: 13px;
    font-weight: 300;
    color: var(--charcoal);
    background: var(--ivory);
    outline: none;
    resize: vertical;
    line-height: 1.8;
    transition: border-color 0.2s;
  }
  .bulk-area:focus { border-color: var(--tiffany); }
  .bulk-section { margin-bottom: 16px; }
  .bulk-label {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 6px;
  }
  .bulk-label span {
    font-size: 13px; font-weight: 500; color: var(--tiffany-deep);
  }
  .teacher-group-title {
    font-size: 12px; font-weight: 500; letter-spacing: 0.5px;
    color: var(--mid-gray); margin: 12px 0 6px;
    text-transform: uppercase;
  }
  .badge {
    padding: 2px 8px; border-radius: 20px; font-size: 10px; font-weight: 500;
    letter-spacing: 0.5px;
  }
  .badge-dam { background: var(--tiffany-pale); color: var(--tiffany-deep); }
  .badge-bidam { background: var(--gold-light); color: #8a6320; }
  .badge-team-a { background: #D4EDDA; color: #155724; font-size:9px; padding:1px 5px; border-radius:10px; }
  .badge-team-b { background: #D1ECF1; color: #0C5460; font-size:9px; padding:1px 5px; border-radius:10px; }
  .badge-days   { background: #E2D9F3; color: #4A235A; font-size:9px; padding:1px 5px; border-radius:10px; }
  .assign-mode-box { background: var(--tiffany-pale); border-radius:8px; padding:10px 12px; margin-bottom:12px; font-size:12px; line-height:1.8; }
  .assign-mode-box b { color: var(--tiffany-deep); }
  .count-badge {
    padding: 2px 8px; border-radius: 20px; font-size: 10px;
    background: var(--light-gray); color: var(--mid-gray);
  }

  /* â”€â”€ CALENDAR â”€â”€ */
  .month-nav {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 14px;
  }
  .month-nav .month-label {
    font-family: 'Cormorant Garamond', serif;
    font-size: 22px; font-weight: 300; letter-spacing: 2px;
    color: var(--tiffany-deep);
  }
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-bottom: 14px;
  }
  .cal-header {
    text-align: center; font-size: 10px; font-weight: 500;
    letter-spacing: 1px; color: var(--mid-gray);
    padding: 4px 0;
    text-transform: uppercase;
  }
  .cal-header:first-child { color: #e05c5c; }
  .cal-header:last-child { color: var(--tiffany); }
  .cal-day {
    background: var(--ivory);
    border-radius: 8px;
    min-height: 70px;
    padding: 5px;
    font-size: 11px;
    border: 1px solid var(--light-gray);
    transition: border-color 0.15s;
    position: relative;
    cursor: default;
  }
  .cal-day.empty { background: transparent; border: none; }
  .cal-day.holiday {
    background: #fef0f0;
    border-color: #f5c6c6;
    opacity: 0.7;
  }
  .cal-day.no-duty {
    background: #f5f5f5;
    border-color: var(--light-gray);
    opacity: 0.6;
  }
  .cal-day.today { border-color: var(--tiffany); border-width: 2px; }
  .cal-day .day-num {
    font-size: 12px; font-weight: 500;
    color: var(--charcoal);
    margin-bottom: 3px;
  }
  .cal-day.sun .day-num { color: #e05c5c; }
  .cal-day.sat .day-num { color: var(--tiffany); }
  .cal-day .assigned {
    font-size: 10px; line-height: 1.5;
    color: var(--charcoal);
  }
  .cal-day .assigned .dam-name { color: var(--tiffany-deep); font-weight: 500; }
  .cal-day .assigned .bidam-name { color: #8a6320; font-weight: 400; }
  .cal-day .no-duty-label {
    font-size: 9px; color: var(--mid-gray); margin-top: 4px;
  }
  .cal-day .edit-btn {
    position: absolute; bottom: 4px; right: 4px;
    background: var(--tiffany); color: var(--white);
    border: none; border-radius: 4px;
    padding: 2px 5px; font-size: 9px;
    cursor: pointer; opacity: 0;
    transition: opacity 0.15s;
  }
  .cal-day:hover .edit-btn { opacity: 1; }
  .cal-day .toggle-btn {
    position: absolute; top: 4px; right: 4px;
    background: transparent; border: none;
    font-size: 10px; cursor: pointer; color: var(--mid-gray);
    transition: color 0.15s;
  }
  .cal-day:hover .toggle-btn { color: #e05c5c; }
  .cal-day.no-duty .toggle-btn { color: #e05c5c; }

  .generate-row { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }

  /* â”€â”€ STATS TABLE â”€â”€ */
  .stats-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }
  .stats-table th {
    background: var(--tiffany);
    color: var(--white);
    padding: 8px 10px;
    text-align: left;
    font-weight: 400;
    letter-spacing: 0.5px;
  }
  .stats-table td {
    padding: 8px 10px;
    border-bottom: 1px solid var(--light-gray);
  }
  .stats-table tr:nth-child(even) td { background: var(--tiffany-pale); }
  .stats-table tr:last-child td { border-bottom: none; }
  .stats-bar {
    background: var(--light-gray);
    border-radius: 4px;
    height: 6px;
    overflow: hidden;
    min-width: 60px;
  }
  .stats-bar-fill {
    background: var(--tiffany);
    height: 100%;
    border-radius: 4px;
    transition: width 0.4s;
  }

  /* â”€â”€ MODAL â”€â”€ */
  .modal-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 1000;
    align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--white);
    border-radius: 16px;
    padding: 24px;
    width: 90%;
    max-width: 360px;
    box-shadow: var(--shadow-deep);
  }
  .modal-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 20px; font-weight: 300;
    color: var(--tiffany-deep);
    margin-bottom: 16px;
    letter-spacing: 1px;
  }
  .modal select, .modal input {
    width: 100%; padding: 9px 12px;
    border: 1px solid var(--light-gray);
    border-radius: 8px;
    font-family: 'Noto Sans KR', sans-serif;
    font-size: 13px; font-weight: 300;
    color: var(--charcoal);
    background: var(--ivory);
    outline: none; margin-bottom: 10px;
  }
  .modal-label { font-size: 11px; color: var(--mid-gray); margin-bottom: 4px; display: block; }
  .modal-btns { display: flex; gap: 8px; margin-top: 8px; }
  .modal-btns .btn { flex: 1; }

  /* â”€â”€ MISC â”€â”€ */
  .helper { font-size: 11px; color: var(--mid-gray); margin-top: 6px; line-height: 1.6; }
  .divider { border: none; border-top: 1px solid var(--light-gray); margin: 16px 0; }
  .flex-row { display: flex; gap: 8px; align-items: center; }
  .label-sm { font-size: 11px; color: var(--mid-gray); letter-spacing: 0.5px; margin-bottom: 4px; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: var(--cream); }
  ::-webkit-scrollbar-thumb { background: var(--tiffany-light); border-radius: 4px; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<header>
  <div class="header-title">ë“±êµì§€ë„ êµì‚¬ ë°°ì •</div>
</header>

<div class="info-box">
  <div class="info-title">ğŸ“‹ ë“±êµì§€ë„ ì•ˆë‚´</div>
  ë‹´ì„ (08ì‹œ ~ 08ì‹œ 35ë¶„)<br>
  ë¹„ë‹´ì„ [08ì‹œ 10ë¶„ ~ 08ì‹œ 45ë¶„]<br>
  <span style="color:var(--mid-gray)">ï¼Š ë‹´ì„ì„ ìƒë‹˜ë“¤ì€ 2ì£¼ë‹¹ ì•½ 1íšŒ, ë¹„ë‹´ì„ì„ ìƒë‹˜ë“¤ì€ ì£¼ë‹¹ 1íšŒë¡œ ê³„íší•˜ì˜€ìŠµë‹ˆë‹¤.</span><br>
  <span style="color:var(--mid-gray)">ï¼Š í•™ìƒë¶€ì¥ ë“±êµì§€ë„ ì´ê´„</span><br>
  <span style="color:var(--mid-gray)">ï¼Š ë‹´ë‹¹: ì†¡í™”ì˜ ë§¤ì£¼ ì›”ìš”ì¼ ë“±êµì§€ë„ (ëª…ë‹¨ì—” ë„£ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.)</span>
</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('teachers')">êµì‚¬ ê´€ë¦¬</div>
  <div class="tab" onclick="switchTab('calendar')">ë°°ì • ë‹¬ë ¥</div>
  <div class="tab" onclick="switchTab('stats')">ëˆ„ì  í†µê³„</div>
</div>

<!-- â•â• PANEL: TEACHERS â•â• -->
<div class="panel active" id="panel-teachers">
  <div class="section-title">ë°°ì • ë°©ì‹</div>
  <div class="assign-mode-box">
    <b>ë‹´ì„</b> â€” AíŒ€ / BíŒ€ìœ¼ë¡œ ë‚˜ëˆ  <b>ì£¼ ë‹¨ìœ„ êµëŒ€</b> ë°°ì •<br>
    <b>ë¹„ë‹´ì„</b> â€” ì „ì²´ ê¸°ê°„ ê· ë“± ìˆœí™˜ ë°°ì • (ë‹´ì„ì˜ ì•½ 2ë°°)<br>
    <span style="color:var(--mid-gray);font-size:11px">âœ¦ êµì‚¬ ëª©ë¡ì—ì„œ ì„ í˜¸ ìš”ì¼ì„ ì§€ì •í•˜ë©´ í•´ë‹¹ ìš”ì¼ì— ìš°ì„  ë°°ì •ë©ë‹ˆë‹¤.<br>â€» ë§¤ì£¼ ì›”ìš”ì¼ ë‹´ë‹¹ìëŠ” ëª…ë‹¨ì— í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.</span>
  </div>

  <div class="bulk-section">
    <div class="bulk-label">
      <span class="badge badge-dam">ë‹´ì„</span>
      <span>AíŒ€ ëª…ë‹¨ (ì¤„ë°”ê¿ˆ êµ¬ë¶„)</span>
    </div>
    <textarea class="bulk-area" id="bulk-dam-a" placeholder="ì˜ˆì‹œ)
ì¡°ì†Œì—°,ëª©
ì´ì§€ì„±,í™”
ì´ì˜ë¯¸" style="min-height:70px"></textarea>
    <div class="helper" style="margin:4px 0 6px">ì„ í˜¸ ìš”ì¼ ì§€ì •: ì´ë¦„,ìš”ì¼ (ì˜ˆ: ì¡°ì†Œì—°,ëª©) â€” ìƒëµ ê°€ëŠ¥</div>
    <button class="btn btn-tiffany btn-full" onclick="bulkAddDam('A')">AíŒ€ ë“±ë¡</button>
  </div>

  <div class="bulk-section">
    <div class="bulk-label">
      <span class="badge badge-dam">ë‹´ì„</span>
      <span>BíŒ€ ëª…ë‹¨ (ì¤„ë°”ê¿ˆ êµ¬ë¶„)</span>
    </div>
    <textarea class="bulk-area" id="bulk-dam-b" placeholder="ì˜ˆì‹œ)
ê³½ë¯¼ê²½,ì›”
í™©ì •ì‹¬,ìˆ˜
ë°•ì„¸ë¼" style="min-height:70px"></textarea>
    <button class="btn btn-tiffany btn-full" onclick="bulkAddDam('B')">BíŒ€ ë“±ë¡</button>
  </div>

  <div class="bulk-section">
    <div class="bulk-label">
      <span class="badge badge-bidam">ë¹„ë‹´ì„</span>
      <span>ë¹„ë‹´ì„ êµì‚¬ ëª…ë‹¨ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</span>
    </div>
    <textarea class="bulk-area" id="bulk-bidam" placeholder="ì˜ˆì‹œ)
ì •ìš©ì±„,í™”
ì´ë¯¼ìˆ˜,ì›”
ìµœìœ¤ì˜,ëª©
ì •ë‹¤ì˜,ê¸ˆ
ë°±ì¤€ê¸°,ìˆ˜" style="min-height:100px"></textarea>
    <div class="helper" style="margin:4px 0 6px">ì„ í˜¸ ìš”ì¼ ì§€ì •: ì´ë¦„,ìš”ì¼ (ì˜ˆ: ì •ìš©ì±„,í™”) â€” ìƒëµ ê°€ëŠ¥</div>
    <button class="btn btn-gold btn-full" onclick="bulkAddBidam()">ë¹„ë‹´ì„ ë“±ë¡</button>
  </div>

  <hr class="divider">
  <div class="section-title">ë“±ë¡ëœ êµì‚¬ ëª©ë¡</div>
  <div class="helper" style="margin-bottom:8px">âœï¸ ì´ë¦„ í´ë¦­ ì‹œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
  <div class="teacher-list" id="teacher-list"></div>

  <hr class="divider">
  <div class="section-title">ë°ì´í„° ê´€ë¦¬</div>
  <div class="flex-row" style="flex-wrap:wrap">
    <button class="btn btn-outline" onclick="exportData()">ğŸ’¾ ì €ì¥ (JSON)</button>
    <button class="btn btn-outline" onclick="exportExcel()" style="background:#E8F5E9;border-color:#388E3C;color:#388E3C">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
    <button class="btn btn-outline" onclick="openLookup()" style="background:#EDE7F6;border-color:#7B1FA2;color:#7B1FA2">ğŸ‘ êµì‚¬ ì¡°íšŒ ì•±</button>
  </div>
  <div class="flex-row" style="margin-top:8px">
    <button class="btn btn-danger" style="flex:1" data-action="reset">ğŸ—‘ ì „ì²´ ì´ˆê¸°í™”</button>
    <button class="btn btn-outline" style="flex:1;display:none" id="restore-btn" data-action="restore">â†© ì´ˆê¸°í™” ë³µêµ¬</button>
  </div>
  <div id="reset-notice" style="display:none;font-size:11px;color:#e05c5c;margin-top:6px">
    ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë³µêµ¬ ë²„íŠ¼ìœ¼ë¡œ ë˜ëŒë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  </div>
</div>

<!-- â•â• PANEL: CALENDAR â•â• -->
<div class="panel" id="panel-calendar">
  <div class="month-nav">
    <button class="btn btn-outline btn-sm" onclick="prevMonth()">â—€</button>
    <div class="month-label" id="month-label"></div>
    <button class="btn btn-outline btn-sm" onclick="nextMonth()">â–¶</button>
  </div>

  <div class="generate-row">
    <button class="btn btn-tiffany" onclick="autoAssign()">âœ¨ ìë™ ë°°ì •</button>
    <button class="btn btn-gold" onclick="clearMonth()">ì´ë‹¬ ì´ˆê¸°í™”</button>
  </div>
  <div class="generate-row" style="margin-top:6px">
    <button class="btn btn-outline" id="btn-equalize" onclick="openEqualizeModal()" style="flex:1;background:var(--ivory);border:1.5px solid var(--tiffany);color:var(--tiffany-deep);font-weight:600" disabled>
      âš–ï¸ ê· ë“± ë°°ì¹˜
    </button>
  </div>
  <div id="equalize-status" style="font-size:11px;color:var(--mid-gray);margin-bottom:6px;display:none"></div>

  <div class="helper" style="margin-bottom:10px">
    âœ¦ ë‚ ì§œ ìš°ì¸¡ ìƒë‹¨ Ã— ë²„íŠ¼: ë“±êµì§€ë„ ì—†ëŠ” ë‚  ì„¤ì • / í•´ì œ<br>
    âœ¦ ë‚ ì§œ ìš°ì¸¡ í•˜ë‹¨ ìˆ˜ì • ë²„íŠ¼: ë°°ì • êµì‚¬ ìˆ˜ê¸° ë³€ê²½
  </div>

  <div class="calendar-grid" id="cal-headers">
    <div class="cal-header">ì¼</div>
    <div class="cal-header">ì›”</div>
    <div class="cal-header">í™”</div>
    <div class="cal-header">ìˆ˜</div>
    <div class="cal-header">ëª©</div>
    <div class="cal-header">ê¸ˆ</div>
    <div class="cal-header">í† </div>
  </div>
  <div class="calendar-grid" id="calendar"></div>
</div>

<!-- â•â• PANEL: STATS â•â• -->
<div class="panel" id="panel-stats">
  <div class="section-title">ì—°ê°„ ëˆ„ì  í†µê³„</div>
  <div style="font-size:12px;color:var(--mid-gray);margin-bottom:12px">
    ì „ì²´ ë°°ì • ì´ë ¥ ê¸°ì¤€ ëˆ„ì  íšŸìˆ˜ì…ë‹ˆë‹¤.
  </div>
  <div id="stats-container"></div>
</div>

<!-- â•â• MODAL: EDIT ASSIGNMENT â•â• -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-title" id="modal-date-title">ë°°ì • ìˆ˜ì •</div>
    <label class="modal-label">ë‹´ì„ êµì‚¬</label>
    <select id="modal-dam"></select>
    <label class="modal-label">ë¹„ë‹´ì„ êµì‚¬</label>
    <select id="modal-bidam"></select>
    <div class="modal-btns">
      <button class="btn btn-tiffany" onclick="saveEdit()">ì €ì¥</button>
      <button class="btn btn-outline" onclick="closeModal()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- â•â• ê· ë“± ë°°ì¹˜ ê¸°ê°„ ì„ íƒ ëª¨ë‹¬ â•â• -->
<div class="modal-overlay" id="equalize-modal">
  <div class="modal" style="max-width:320px">
    <div class="modal-title">âš–ï¸ ê· ë“± ë°°ì¹˜ ê¸°ê°„ ì„¤ì •</div>
    <div style="font-size:12px;color:var(--mid-gray);margin-bottom:14px;line-height:1.6">
      ì„ íƒí•œ ê¸°ê°„ì˜ ë°°ì •ì„ ë¶„ì„í•´<br>
      ë‹´ì„Â·ë¹„ë‹´ì„ì´ ê°ê° ê· ë“±í•´ì§€ë„ë¡ ì´ë¦„ì„ êµì²´í•©ë‹ˆë‹¤.
    </div>
    <label class="modal-label">ì‹œì‘ ì›”</label>
    <select id="eq-from" style="width:100%;padding:9px 12px;border:1px solid var(--light-gray);border-radius:8px;font-family:'Noto Sans KR',sans-serif;font-size:13px;background:var(--ivory);margin-bottom:10px"></select>
    <label class="modal-label">ì¢…ë£Œ ì›”</label>
    <select id="eq-to" style="width:100%;padding:9px 12px;border:1px solid var(--light-gray);border-radius:8px;font-family:'Noto Sans KR',sans-serif;font-size:13px;background:var(--ivory);margin-bottom:4px"></select>
    <div id="eq-preview" style="font-size:11px;color:var(--mid-gray);margin:8px 0 14px;min-height:16px"></div>
    <div class="modal-btns">
      <button class="btn btn-tiffany" onclick="runEqualize()">ê· ë“± ë°°ì¹˜ ì‹¤í–‰</button>
      <button class="btn btn-outline" onclick="closeEqualizeModal()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  teachers: [],
  assignments: {},  // "YYYY-MM-DD": {dam: name, bidam: name} | "off"
};

let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth(); // 0-based
let editingDate = null;

const STORAGE_KEY = 'morning_duty_v1';

// â”€â”€ Load from localStorage â”€â”€
function load() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (raw) {
    try { state = JSON.parse(raw); } catch(e) {}
  }
}
function save() {
  state._savedAt = new Date().toISOString();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('panel-' + tab).classList.add('active');
  if (tab === 'calendar') renderCalendar();
  if (tab === 'stats') renderStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TEACHERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function bulkAddDam(team) {
  const areaId = team === 'A' ? 'bulk-dam-a' : 'bulk-dam-b';
  const text = document.getElementById(areaId).value.trim();
  if (!text) return;
  const DAY_MAP = {'ì›”':1,'í™”':2,'ìˆ˜':3,'ëª©':4,'ê¸ˆ':5};
  const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
  let added = 0, skipped = 0;
  lines.forEach(line => {
    const parts = line.split(',').map(p => p.trim());
    const name = parts[0];
    const prefDay = parts[1] ? (DAY_MAP[parts[1]] || 0) : 0;
    if (!name) return;
    if (state.teachers.find(t => t.name === name)) { skipped++; return; }
    state.teachers.push({ name, type: 'ë‹´ì„', team, prefDay });
    added++;
  });
  document.getElementById(areaId).value = '';
  save();
  renderTeachers();
  alert(`${team}íŒ€ ${added}ëª… ë“±ë¡ ì™„ë£Œ${skipped > 0 ? ` (${skipped}ëª… ì¤‘ë³µ ì œì™¸)` : ''}`);
}

function bulkAddBidam() {
  const text = document.getElementById('bulk-bidam').value.trim();
  if (!text) return;
  const DAY_MAP = {'ì›”':1,'í™”':2,'ìˆ˜':3,'ëª©':4,'ê¸ˆ':5};
  const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
  let added = 0, skipped = 0;
  lines.forEach(line => {
    const parts = line.split(',').map(p => p.trim());
    const name = parts[0];
    const prefDay = parts[1] ? (DAY_MAP[parts[1]] || 0) : 0;
    if (!name) return;
    if (state.teachers.find(t => t.name === name)) { skipped++; return; }
    state.teachers.push({ name, type: 'ë¹„ë‹´ì„', prefDay });
    added++;
  });
  document.getElementById('bulk-bidam').value = '';
  save();
  renderTeachers();
  alert(`ë¹„ë‹´ì„ ${added}ëª… ë“±ë¡ ì™„ë£Œ${skipped > 0 ? ` (${skipped}ëª… ì¤‘ë³µ ì œì™¸)` : ''}`);
}

function startEditName(idx) {
  const item = document.getElementById(`teacher-item-${idx}`);
  if (!item) return;
  const nameSpan = item.querySelector('[data-edit]');
  if (!nameSpan) return;
  const currentName = state.teachers[idx].name;
  const input = document.createElement('input');
  input.className = 'teacher-name-edit';
  input.id = `edit-inp-${idx}`;
  input.value = currentName;
  input.addEventListener('blur', () => finishEditName(idx));
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') finishEditName(idx);
    if (e.key === 'Escape') renderTeachers();
  });
  nameSpan.replaceWith(input);
  input.focus();
  input.select();
}

function finishEditName(idx) {
  const inp = document.getElementById(`edit-inp-${idx}`);
  if (!inp) return;
  const newName = inp.value.trim();
  const oldName = state.teachers[idx].name;
  if (!newName || newName === oldName) { renderTeachers(); return; }
  if (state.teachers.find((t,i) => t.name === newName && i !== idx)) {
    alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.'); inp.focus(); return;
  }
  // Update assignments too
  Object.keys(state.assignments).forEach(key => {
    const a = state.assignments[key];
    if (a && typeof a === 'object') {
      if (a.dam === oldName) a.dam = newName;
      if (a.bidam === oldName) a.bidam = newName;
    }
  });
  state.teachers[idx].name = newName;
  save();
  renderTeachers();
}

function removeTeacher(idx) {
  const teacher = state.teachers[idx];
  if (!teacher) return;
  state.teachers.splice(idx, 1);
  save();
  renderTeachers();
}

function renderTeachers() {
  const list = document.getElementById('teacher-list');
  if (!state.teachers.length) {
    list.innerHTML = '<div class="helper" style="text-align:center;padding:20px">ì•„ì§ ë“±ë¡ëœ êµì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  const counts = getCounts();
  const DAY_NAMES = {1:'ì›”',2:'í™”',3:'ìˆ˜',4:'ëª©',5:'ê¸ˆ'};
  const damA  = state.teachers.map((t,i) => ({...t,i})).filter(t => t.type==='ë‹´ì„' && t.team==='A');
  const damB  = state.teachers.map((t,i) => ({...t,i})).filter(t => t.type==='ë‹´ì„' && t.team==='B');
  const bidam = state.teachers.map((t,i) => ({...t,i})).filter(t => t.type==='ë¹„ë‹´ì„');
  bidam.sort((a,b) => (a.day||0) - (b.day||0));

  const DAY_OPTIONS = ['ì—†ìŒ','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'];
  const renderItem = (t, badgeCls, extra) => `
    <div class="teacher-item" id="teacher-item-${t.i}">
      <span class="teacher-name" data-edit="${t.i}" title="í´ë¦­í•˜ì—¬ ì´ë¦„ ìˆ˜ì •" style="cursor:pointer">${t.name}</span>
      <span class="badge ${badgeCls}">${extra}</span>
      <select class="pref-day-sel" data-pref="${t.i}"
        style="font-size:11px;padding:2px 4px;border:1px solid var(--light-gray);
               border-radius:6px;background:var(--ivory);cursor:pointer;color:var(--tiffany-deep);font-weight:500">
        ${DAY_OPTIONS.map((d,i) => `<option value="${i}" ${(t.prefDay||0)===i?'selected':''}>${d}</option>`).join('')}
      </select>
      <span class="count-badge">${counts[t.name] || 0}íšŒ</span>
      <button class="btn btn-danger btn-sm" data-del="${t.i}">ì‚­ì œ</button>
    </div>`;

  let html = '';
  if (damA.length) {
    html += `<div class="teacher-group-title">ë‹´ì„ AíŒ€ (${damA.length}ëª…) â€” í™€ìˆ˜ì£¼ ë°°ì •</div>`;
    html += damA.map(t => renderItem(t, 'badge-dam', 'AíŒ€')).join('');
  }
  if (damB.length) {
    html += `<div class="teacher-group-title">ë‹´ì„ BíŒ€ (${damB.length}ëª…) â€” ì§ìˆ˜ì£¼ ë°°ì •</div>`;
    html += damB.map(t => renderItem(t, 'badge-dam', 'BíŒ€')).join('');
  }
  if (bidam.length) {
    html += `<div class="teacher-group-title">ë¹„ë‹´ì„ êµì‚¬ (${bidam.length}ëª…) â€” 2ì£¼ 2íšŒ ê· ë“± ë°°ì •</div>`;
    html += bidam.map(t => renderItem(t, 'badge-bidam', 'ë¹„ë‹´ì„')).join('');
  }
  list.innerHTML = html || '<div class="helper" style="text-align:center;padding:20px">ì•„ì§ ë“±ë¡ëœ êµì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
}

// â”€â”€ ì´ë²¤íŠ¸ ìœ„ì„: ëª¨ë“  data-action/data-del/data-edit í•œ ê³³ì—ì„œ ì²˜ë¦¬ â”€â”€
document.addEventListener('click', function(e) {
  if (e.target.matches('[data-del]')) {
    const idx = parseInt(e.target.getAttribute('data-del'));
    removeTeacher(idx);
    return;
  }
  if (e.target.matches('[data-edit]')) {
    const idx = parseInt(e.target.getAttribute('data-edit'));
    startEditName(idx);
    return;
  }
  const action = e.target.getAttribute('data-action');
  if (action === 'reset')   { resetAll();   return; }
  if (action === 'restore') { restoreAll(); return; }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CALENDAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCalendar() {
  const label = document.getElementById('month-label');
  label.textContent = `${currentYear}ë…„ ${currentMonth + 1}ì›”`;

  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  const today = new Date();
  const todayStr = dateKey(today.getFullYear(), today.getMonth(), today.getDate());

  const grid = document.getElementById('calendar');
  let html = '';

  // Empty cells
  for (let i = 0; i < firstDay; i++) html += '<div class="cal-day empty"></div>';

  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(currentYear, currentMonth, d);
    const dow = date.getDay();
    const key = dateKey(currentYear, currentMonth, d);
    const asgn = state.assignments[key];
    const isOff = asgn === 'off';
    const isToday = key === todayStr;
    const isWeekend = dow === 0 || dow === 6;

    let cls = 'cal-day';
    if (dow === 0) cls += ' sun';
    if (dow === 6) cls += ' sat';
    if (isOff) cls += ' no-duty';
    if (isToday) cls += ' today';

    let inner = `<div class="day-num">${d}</div>`;
    inner += `<button class="toggle-btn" title="ë“±êµì§€ë„ ì—†ëŠ” ë‚  ì„¤ì •/í•´ì œ" onclick="toggleOff('${key}')">âœ•</button>`;


    if (isOff) {
      inner += `<div class="no-duty-label">ë“±êµì§€ë„ ì—†ìŒ</div>`;
    } else if (asgn && typeof asgn === 'object') {
      inner += `<div class="assigned">
        ${asgn.dam ? `<div class="dam-name">â–¸ ${asgn.dam}</div>` : ''}
        ${asgn.bidam ? `<div class="bidam-name">â–¸ ${asgn.bidam}</div>` : ''}
        ${asgn.bidam2 ? `<div class="bidam-name">â–¸ ${asgn.bidam2}</div>` : ''}
      </div>`;
      if (!isWeekend) {
        inner += `<button class="edit-btn" onclick="openEdit('${key}')">ìˆ˜ì •</button>`;
      }
    } else if (!isWeekend) {
      inner += `<button class="edit-btn" onclick="openEdit('${key}')">ë°°ì •</button>`;
    }

    html += `<div class="${cls}">${inner}</div>`;
  }

  grid.innerHTML = html;
}

function prevMonth() {
  currentMonth--;
  if (currentMonth < 0) { currentMonth = 11; currentYear--; }
  renderCalendar();
}
function nextMonth() {
  currentMonth++;
  if (currentMonth > 11) { currentMonth = 0; currentYear++; }
  renderCalendar();
}

function toggleOff(key) {
  if (state.assignments[key] === 'off') {
    delete state.assignments[key];
  } else {
    state.assignments[key] = 'off';
  }
  save();
  renderCalendar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTO ASSIGN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì´ë‹¬ ë°°ì •(off ì œì™¸)ë§Œ ì‚­ì œí•˜ëŠ” ê³µí†µ í•¨ìˆ˜
function deleteMonthAssignments() {
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  for (let d = 1; d <= daysInMonth; d++) {
    const key = dateKey(currentYear, currentMonth, d);
    if (state.assignments[key] && state.assignments[key] !== 'off') {
      delete state.assignments[key];
    }
  }
}

function autoAssign() {
  const dams   = state.teachers.filter(t => t.type === 'ë‹´ì„');
  const bidams = state.teachers.filter(t => t.type === 'ë¹„ë‹´ì„');
  if (!dams.length && !bidams.length) { alert('êµì‚¬ë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.'); return; }

  deleteMonthAssignments();

  const teamA = dams.filter(t => t.team === 'A');
  const teamB = dams.filter(t => t.team === 'B');
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

  // í‰ì¼ ëª©ë¡ (off ì œì™¸)
  const allDays = [];
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(currentYear, currentMonth, d);
    const dow  = date.getDay(); // 0=ì¼,1=ì›”~5=ê¸ˆ,6=í† 
    const key  = dateKey(currentYear, currentMonth, d);
    if (dow === 0 || dow === 6) continue;
    if (state.assignments[key] === 'off') continue;
    allDays.push({ d, date, key, dow });
  }

  // í‰ì¼ì„ ì£¼ ë‹¨ìœ„(ìµœëŒ€ 5ì¼ì”©)ë¡œ ë¶„ë¦¬
  // ì›”ìš”ì¼ ì‹œì‘ì´ ì•„ë‹ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê·¸ëƒ¥ 5ê°œì”© ë¬¶ìŒ
  const weeks = [];
  for (let i = 0; i < allDays.length; i += 5) {
    weeks.push(allDays.slice(i, i + 5));
  }

  // ë‹´ì„ íŒ€ êµëŒ€: state.lastTeam ì´ì–´ë°›ê¸°
  let currentTeam  = state.lastTeam || 'A';
  // 2ì£¼ ë¸”ë¡ ì¹´ìš´í„°: state.weekCount ì´ì–´ë°›ê¸°
  let weekCount    = state.weekCount || 0;
  // ëˆ„ì  íšŸìˆ˜ (ë‹¤ë¥¸ ë‹¬ í¬í•¨)
  const cnt = getCounts();

  // 2ì£¼ ë¸”ë¡ ë‚´ ë‹´ì„ ì‚¬ìš© í˜„í™©
  let damBiweekUsed = new Set(state.damBiweekUsed || []);

  // ìš”ì¼ ìš°ì„ , ëˆ„ì  ìµœì†Œë¡œ 1ëª… ì„ íƒ (ì´ë²ˆ ê¸°ê°„ ì´ë¯¸ ë‚˜ì˜¨ ì‚¬ëŒ ì œì™¸)
  function pickOne(pool, dow, usedThisPeriod, cntMap) {
    let avail = pool.filter(t => !usedThisPeriod.has(t.name));
    if (!avail.length) avail = [...pool];
    // ì„ í˜¸ ìš”ì¼ ë§ëŠ” ì‚¬ëŒ ìš°ì„ 
    const pref = avail.filter(t => (t.prefDay || 0) === dow);
    const candidates = pref.length ? pref : avail;
    candidates.sort((a, b) => (cntMap[a.name] || 0) - (cntMap[b.name] || 0));
    return candidates[0];
  }

  for (const week of weeks) {
    const activeTeam = currentTeam === 'A' ? teamA : teamB;
    const bidamWeekUsed = new Set();

    for (const day of week) {
      // ë‹´ì„ ë°°ì •
      let damPick = '';
      if (activeTeam.length) {
        const t = pickOne(activeTeam, day.dow, damBiweekUsed, cnt);
        damPick = t.name;
        damBiweekUsed.add(damPick);
        cnt[damPick] = (cnt[damPick] || 0) + 1;
      }

      // ë¹„ë‹´ì„ ë°°ì •
      let bidamPick = '';
      if (bidams.length) {
        const t = pickOne(bidams, day.dow, bidamWeekUsed, cnt);
        bidamPick = t.name;
        bidamWeekUsed.add(bidamPick);
        cnt[bidamPick] = (cnt[bidamPick] || 0) + 1;
      }

      state.assignments[day.key] = { dam: damPick, bidam: bidamPick };
    }

    weekCount++;
    // 2ì£¼(2ë²ˆ)ë§ˆë‹¤ íŒ€ êµëŒ€ + ë‹´ì„ ë¸”ë¡ ì´ˆê¸°í™”
    if (weekCount % 2 === 0) {
      currentTeam   = currentTeam === 'A' ? 'B' : 'A';
      damBiweekUsed = new Set();
    }
  }

  // ë‹¤ìŒ ë‹¬ì„ ìœ„í•´ ì €ì¥
  state.lastTeam      = currentTeam;
  state.weekCount     = weekCount;
  state.damBiweekUsed = [...damBiweekUsed];

  save();
  renderCalendar();
  updateEqualizeBtn();
}
function getWeekNumber(date) {
  const d = new Date(date);
  d.setHours(0,0,0,0);
  d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
  const wk1 = new Date(d.getFullYear(), 0, 4);
  return 1 + Math.round(((d - wk1) / 86400000 - 3 + (wk1.getDay() + 6) % 7) / 7);
}
function clearMonth() {
  deleteMonthAssignments();
  save();
  renderCalendar();
  updateEqualizeBtn();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EDIT MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openEdit(key) {
  editingDate = key;
  const [y,m,d] = key.split('-');
  document.getElementById('modal-date-title').textContent =
    `${+y}ë…„ ${+m}ì›” ${+d}ì¼ ë°°ì • ìˆ˜ì •`;

  const asgn = state.assignments[key] || {};
  const allTeachers = state.teachers;

  const damSel   = document.getElementById('modal-dam');
  const bidamSel = document.getElementById('modal-bidam');

  // ë‹´ì„/ë¹„ë‹´ì„ êµ¬ë¶„ì„  í¬í•¨ ì „ì²´ êµì‚¬ ëª©ë¡ ìƒì„±
  function buildOptions(sel, currentVal) {
    const dams   = allTeachers.filter(t => t.type === 'ë‹´ì„');
    const bidams = allTeachers.filter(t => t.type === 'ë¹„ë‹´ì„');
    let html = `<option value="">-- ì„ íƒ ì•ˆ í•¨ --</option>`;
    if (dams.length) {
      html += `<optgroup label="â”€â”€ ë‹´ì„ â”€â”€">` +
        dams.map(t => `<option value="${t.name}" ${currentVal===t.name?'selected':''}>${t.name}</option>`).join('') +
        `</optgroup>`;
    }
    if (bidams.length) {
      html += `<optgroup label="â”€â”€ ë¹„ë‹´ì„ â”€â”€">` +
        bidams.map(t => `<option value="${t.name}" ${currentVal===t.name?'selected':''}>${t.name}</option>`).join('') +
        `</optgroup>`;
    }
    sel.innerHTML = html;
  }

  buildOptions(damSel,   asgn.dam   || '');
  buildOptions(bidamSel, asgn.bidam || '');

  document.getElementById('edit-modal').classList.add('open');
}

function saveEdit() {
  const dam = document.getElementById('modal-dam').value;
  const bidam = document.getElementById('modal-bidam').value;
  if (dam || bidam) {
    state.assignments[editingDate] = { dam: dam || '', bidam: bidam || '' };
  } else {
    delete state.assignments[editingDate];
  }
  save();
  closeModal();
  renderCalendar();
  updateEqualizeBtn();
}

function closeModal() {
  document.getElementById('edit-modal').classList.remove('open');
  editingDate = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getCounts() {
  const counts = {};
  state.teachers.forEach(t => counts[t.name] = 0);
  Object.values(state.assignments).forEach(a => {
    if (a && typeof a === 'object') {
      if (a.dam) counts[a.dam] = (counts[a.dam] || 0) + 1;
      if (a.bidam) counts[a.bidam] = (counts[a.bidam] || 0) + 1;
    }
  });
  return counts;
}

// â”€â”€ ê· ë“± ë°°ì¹˜ â”€â”€
function openEqualizeModal() {
  // ë°°ì •ëœ ë‹¬ ëª©ë¡ ìˆ˜ì§‘
  const months = [...new Set(
    Object.keys(state.assignments)
      .filter(k => state.assignments[k] && typeof state.assignments[k] === 'object')
      .map(k => k.slice(0, 7))  // "YYYY-MM"
  )].sort();

  if (!months.length) { alert('ë°°ì •ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

  const fromSel = document.getElementById('eq-from');
  const toSel   = document.getElementById('eq-to');

  const opts = months.map(mk => {
    const [y, m] = mk.split('-');
    return `<option value="${mk}">${+y}ë…„ ${+m}ì›”</option>`;
  }).join('');

  fromSel.innerHTML = opts;
  toSel.innerHTML   = opts;
  toSel.selectedIndex = months.length - 1;  // ê¸°ë³¸: ë§ˆì§€ë§‰ ë‹¬

  updateEqPreview();
  fromSel.onchange = updateEqPreview;
  toSel.onchange   = updateEqPreview;

  document.getElementById('equalize-modal').classList.add('open');
}

function updateEqPreview() {
  const from = document.getElementById('eq-from').value;
  const to   = document.getElementById('eq-to').value;
  const prev = document.getElementById('eq-preview');

  if (from > to) {
    prev.style.color = '#e05c5c';
    prev.textContent = 'âš ï¸ ì‹œì‘ ì›”ì´ ì¢…ë£Œ ì›”ë³´ë‹¤ ëŠ¦ìŠµë‹ˆë‹¤.';
    return;
  }

  // í•´ë‹¹ ê¸°ê°„ ë°°ì •ì¼ ìˆ˜ & êµì‚¬ë³„ íšŸìˆ˜ ë¯¸ë¦¬ë³´ê¸°
  const keys = Object.keys(state.assignments)
    .filter(k => {
      const mk = k.slice(0, 7);
      return mk >= from && mk <= to && state.assignments[k] && typeof state.assignments[k] === 'object';
    });

  const dams   = state.teachers.filter(t => t.type === 'ë‹´ì„');
  const bidams = state.teachers.filter(t => t.type === 'ë¹„ë‹´ì„');

  // ê¸°ê°„ ë‚´ íšŸìˆ˜ ê³„ì‚°
  const cnt = {};
  state.teachers.forEach(t => { cnt[t.name] = 0; });
  keys.forEach(k => {
    const a = state.assignments[k];
    if (a.dam)   cnt[a.dam]   = (cnt[a.dam]   || 0) + 1;
    if (a.bidam) cnt[a.bidam] = (cnt[a.bidam] || 0) + 1;
  });

  const damVals   = dams.map(t => cnt[t.name] || 0);
  const bidamVals = bidams.map(t => cnt[t.name] || 0);
  const dMin = Math.min(...damVals),   dMax = Math.max(...damVals);
  const bMin = Math.min(...bidamVals), bMax = Math.max(...bidamVals);

  prev.style.color = 'var(--mid-gray)';
  prev.textContent = `ë°°ì •ì¼ ${keys.length}ì¼ â€” ë‹´ì„ ${dMin}~${dMax}íšŒ / ë¹„ë‹´ì„ ${bMin}~${bMax}íšŒ`;
}

function closeEqualizeModal() {
  document.getElementById('equalize-modal').classList.remove('open');
}

function runEqualize() {
  const from = document.getElementById('eq-from').value;
  const to   = document.getElementById('eq-to').value;
  if (from > to) { alert('ì‹œì‘ ì›”ì´ ì¢…ë£Œ ì›”ë³´ë‹¤ ëŠ¦ìŠµë‹ˆë‹¤.'); return; }

  closeEqualizeModal();
  equalizeAssign(from, to);
}

function equalizeAssign(fromMk, toMk) {
  const dams   = state.teachers.filter(t => t.type === 'ë‹´ì„');
  const bidams = state.teachers.filter(t => t.type === 'ë¹„ë‹´ì„');
  if (!dams.length && !bidams.length) return;

  // ê¸°ê°„ ë‚´ ë°°ì •ì¼ í‚¤ ëª©ë¡
  const assignedDates = Object.keys(state.assignments)
    .filter(k => {
      const mk = k.slice(0, 7);
      return mk >= fromMk && mk <= toMk &&
             state.assignments[k] && typeof state.assignments[k] === 'object';
    })
    .sort();

  if (!assignedDates.length) {
    alert('í•´ë‹¹ ê¸°ê°„ì— ë°°ì •ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  // â”€â”€ ê¸°ê°„ ë‚´ íšŸìˆ˜ ê³„ì‚° í•¨ìˆ˜ â”€â”€
  function getPeriodCounts() {
    const c = {};
    state.teachers.forEach(t => { c[t.name] = 0; });
    assignedDates.forEach(k => {
      const a = state.assignments[k];
      if (a.dam)   c[a.dam]   = (c[a.dam]   || 0) + 1;
      if (a.bidam) c[a.bidam] = (c[a.bidam] || 0) + 1;
    });
    return c;
  }

  // â”€â”€ ëª©í‘œ íšŸìˆ˜ ê³„ì‚° â”€â”€
  // ë¹„ë‹´ì„ì´ ë‹´ì„ì˜ 2ë°°ê°€ ë˜ë„ë¡ + ê° ê·¸ë£¹ ë‚´ ê· ë“±
  // ê¸°ê°„ ë‚´ ì´ ë°°ì •ì¼ = damTotal = bidamTotal (ë§¤ì¼ 1ë‹´ì„ + 1ë¹„ë‹´ì„)
  // ë‹´ì„ ëª©í‘œ = ì´ë°°ì •ì¼ / ë‹´ì„ìˆ˜
  // ë¹„ë‹´ì„ ëª©í‘œ = ì´ë°°ì •ì¼ / ë¹„ë‹´ì„ìˆ˜
  // â†’ ë¹„ë‹´ì„ìˆ˜ = ë‹´ì„ìˆ˜/2 ì´ë©´ ë¹„ë‹´ì„ì´ 2ë°°
  const cnt0 = getPeriodCounts();
  const damTotal   = dams.reduce((s, t) => s + (cnt0[t.name] || 0), 0);
  const bidamTotal = bidams.reduce((s, t) => s + (cnt0[t.name] || 0), 0);
  const damTarget   = damTotal   / dams.length;
  const bidamTarget = bidamTotal / bidams.length;

  let changed = 0;
  const maxIter = (dams.length + bidams.length) * 30;

  for (let iter = 0; iter < maxIter; iter++) {
    const cnt2 = getPeriodCounts();

    // ë‹´ì„: ëª©í‘œ ê¸°ì¤€ ì´ˆê³¼/ë¯¸ë‹¬
    const dOver  = [...dams].filter(t => (cnt2[t.name]||0) > Math.ceil(damTarget))
                            .sort((a,b) => (cnt2[b.name]||0)-(cnt2[a.name]||0));
    const dUnder = [...dams].filter(t => (cnt2[t.name]||0) < Math.floor(damTarget))
                            .sort((a,b) => (cnt2[a.name]||0)-(cnt2[b.name]||0));

    // ë¹„ë‹´ì„: ëª©í‘œ ê¸°ì¤€ ì´ˆê³¼/ë¯¸ë‹¬
    const bOver  = [...bidams].filter(t => (cnt2[t.name]||0) > Math.ceil(bidamTarget))
                              .sort((a,b) => (cnt2[b.name]||0)-(cnt2[a.name]||0));
    const bUnder = [...bidams].filter(t => (cnt2[t.name]||0) < Math.floor(bidamTarget))
                              .sort((a,b) => (cnt2[a.name]||0)-(cnt2[b.name]||0));

    if (!dOver.length && !bOver.length) break;

    let swapped = false;

    // ë‹´ì„ êµì²´
    for (const over of dOver) {
      if (!dUnder.length) break;
      const under = dUnder[0];
      for (const key of assignedDates) {
        const a = state.assignments[key];
        if (a.dam === over.name && a.bidam !== under.name) {
          a.dam = under.name;
          changed++;
          swapped = true;
          break;
        }
      }
      if (swapped) break;
    }

    if (!swapped) {
      // ë¹„ë‹´ì„ êµì²´
      for (const over of bOver) {
        if (!bUnder.length) break;
        const under = bUnder[0];
        for (const key of assignedDates) {
          const a = state.assignments[key];
          if (a.bidam === over.name && a.dam !== under.name) {
            a.bidam = under.name;
            changed++;
            swapped = true;
            break;
          }
        }
        if (swapped) break;
      }
    }

    if (!swapped) break;
  }

  // ê²°ê³¼ í‘œì‹œ
  const finalCnt  = getPeriodCounts();
  const damVals   = dams.map(t => finalCnt[t.name]   || 0);
  const bidamVals = bidams.map(t => finalCnt[t.name] || 0);
  const dMin = Math.min(...damVals),   dMax = Math.max(...damVals);
  const bMin = Math.min(...bidamVals), bMax = Math.max(...bidamVals);

  const [fy, fm] = fromMk.split('-');
  const [ty, tm] = toMk.split('-');
  const rangeStr = fromMk === toMk
    ? `${+fy}ë…„ ${+fm}ì›”`
    : `${+fy}ë…„ ${+fm}ì›” ~ ${+ty}ë…„ ${+tm}ì›”`;

  const statusEl = document.getElementById('equalize-status');
  statusEl.style.display = 'block';

  if (changed > 0) {
    statusEl.style.color = 'var(--tiffany-deep)';
    statusEl.innerHTML =
      `âœ… <b>${rangeStr}</b> ${changed}ê±´ ì¡°ì • â€” ë‹´ì„ ${dMin}~${dMax}íšŒ / ë¹„ë‹´ì„ ${bMin}~${bMax}íšŒ`;
    save();
    renderCalendar();
    updateEqualizeBtn();
  } else {
    statusEl.style.color = 'var(--mid-gray)';
    statusEl.innerHTML =
      `ì´ë¯¸ ê· ë“±í•©ë‹ˆë‹¤ (${rangeStr}) â€” ë‹´ì„ ${dMin}~${dMax}íšŒ / ë¹„ë‹´ì„ ${bMin}~${bMax}íšŒ`;
  }
}


// ê· ë“± ë°°ì¹˜ ë²„íŠ¼ í™œì„±í™” ì—¬ë¶€ íŒë‹¨
function updateEqualizeBtn() {
  const btn = document.getElementById('btn-equalize');
  const statusEl = document.getElementById('equalize-status');
  if (!btn) return;

  const dams   = state.teachers.filter(t => t.type === 'ë‹´ì„');
  const bidams = state.teachers.filter(t => t.type === 'ë¹„ë‹´ì„');
  const hasAssignments = Object.values(state.assignments)
    .some(a => a && typeof a === 'object' && (a.dam || a.bidam));

  if (!hasAssignments || (!dams.length && !bidams.length)) {
    btn.disabled = true;
    statusEl.style.display = 'none';
    return;
  }

  const cnt = getCounts();

  // ë‹´ì„/ë¹„ë‹´ì„ ê°ê° ë¶ˆê· ë“± ì—¬ë¶€ ì²´í¬
  function isUnequal(pool) {
    if (pool.length < 2) return false;
    const vals = pool.map(t => cnt[t.name] || 0);
    return Math.max(...vals) - Math.min(...vals) > 1;
  }

  const needsEq = isUnequal(dams) || isUnequal(bidams);
  btn.disabled = !needsEq;
  btn.style.opacity = needsEq ? '1' : '0.5';

  if (needsEq) {
    const damVals   = dams.map(t => cnt[t.name] || 0);
    const bidamVals = bidams.map(t => cnt[t.name] || 0);
    const parts = [];
    if (dams.length > 1)   parts.push(`ë‹´ì„ ${Math.min(...damVals)}~${Math.max(...damVals)}íšŒ`);
    if (bidams.length > 1) parts.push(`ë¹„ë‹´ì„ ${Math.min(...bidamVals)}~${Math.max(...bidamVals)}íšŒ`);
    statusEl.style.display = 'block';
    statusEl.style.color = '#c0392b';
    statusEl.textContent = `âš ï¸ ë¶ˆê· ë“± ê°ì§€: ${parts.join(' / ')}`;
  } else {
    if (hasAssignments) {
      const damVals   = dams.map(t => cnt[t.name] || 0);
      const bidamVals = bidams.map(t => cnt[t.name] || 0);
      statusEl.style.display = 'block';
      statusEl.style.color = 'var(--mid-gray)';
      statusEl.textContent = dams.length && bidams.length
        ? `ë‹´ì„ ${Math.min(...damVals)}~${Math.max(...damVals)}íšŒ / ë¹„ë‹´ì„ ${Math.min(...bidamVals)}~${Math.max(...bidamVals)}íšŒ`
        : '';
    }
  }
}


function renderStats() {
  const counts = getCounts();
  const container = document.getElementById('stats-container');
  if (!state.teachers.length) {
    container.innerHTML = '<div class="helper" style="text-align:center;padding:20px">êµì‚¬ ëª…ë‹¨ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.</div>';
    return;
  }

  const sorted = [...state.teachers].sort((a,b) => (counts[b.name]||0) - (counts[a.name]||0));
  const max = Math.max(...sorted.map(t => counts[t.name]||0), 1);

  let html = `<table class="stats-table">
    <thead><tr><th>ì´ë¦„</th><th>êµ¬ë¶„</th><th>íšŸìˆ˜</th><th>ë¹„ìœ¨</th></tr></thead>
    <tbody>`;
  sorted.forEach(t => {
    const cnt = counts[t.name] || 0;
    const pct = Math.round((cnt / max) * 100);
    html += `<tr>
      <td style="font-weight:500">${t.name}</td>
      <td><span class="badge ${t.type==='ë‹´ì„'?'badge-dam':'badge-bidam'}">${t.type}</span></td>
      <td style="font-weight:500;color:var(--tiffany-deep)">${cnt}íšŒ</td>
      <td><div class="stats-bar"><div class="stats-bar-fill" style="width:${pct}%"></div></div></td>
    </tr>`;
  });
  html += `</tbody></table>`;

  const total = Object.values(state.assignments).filter(a => a && typeof a === 'object').length;
  html += `<div class="helper" style="margin-top:12px;text-align:right">ì´ ë°°ì •ì¼: <strong>${total}ì¼</strong></div>`;

  container.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dateKey(y, m, d) {
  return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
}

function weekKey(date) {
  // ISO week: year + week number
  const d = new Date(date);
  d.setHours(0,0,0,0);
  d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
  const wk1 = new Date(d.getFullYear(), 0, 4);
  const wn = 1 + Math.round(((d - wk1) / 86400000 - 3 + (wk1.getDay() + 6) % 7) / 7);
  return `${d.getFullYear()}-W${wn}`;
}

function biweekKey(date) {
  // Group weeks into pairs (week 1&2, 3&4, ...)
  const d = new Date(date);
  d.setHours(0,0,0,0);
  d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
  const wk1 = new Date(d.getFullYear(), 0, 4);
  const wn = 1 + Math.round(((d - wk1) / 86400000 - 3 + (wk1.getDay() + 6) % 7) / 7);
  const biweek = Math.ceil(wn / 2);
  return `${d.getFullYear()}-BW${biweek}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMPORT / EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLookup() {
  window.open('ë“±êµì§€ë„ì¡°íšŒ.html', '_blank');
}

function exportData() {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `ë“±êµì§€ë„_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}

function exportExcel() {
  const assignments = state.assignments;
  const allKeys = Object.keys(assignments)
    .filter(k => assignments[k] && typeof assignments[k] === 'object')
    .sort();

  if (!allKeys.length) { alert('ë°°ì •ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

  const DAY_KR = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  const wb = XLSX.utils.book_new();

  // â”€â”€ ì‹œíŠ¸1: ì›”ë³„ ë‹¬ë ¥í˜• ë°°ì •í‘œ â”€â”€
  // ì›”ë³„ë¡œ ê·¸ë£¹í•‘
  const byMonth = {};
  allKeys.forEach(key => {
    const [y, m] = key.split('-');
    const mk = `${y}-${m}`;
    if (!byMonth[mk]) byMonth[mk] = [];
    byMonth[mk].push(key);
  });

  const calRows = [];
  calRows.push(['ë‚ ì§œ', 'ìš”ì¼', 'ë‹´ì„', 'ë¹„ë‹´ì„']);

  let prevMonth = '';
  allKeys.forEach(key => {
    const [y, m, d] = key.split('-').map(Number);
    const mk = `${y}-${String(m).padStart(2,'0')}`;
    const a = assignments[key];
    const date = new Date(y, m-1, d);
    const dow = DAY_KR[date.getDay()];

    if (mk !== prevMonth) {
      if (prevMonth) calRows.push(['', '', '', '']);
      calRows.push([`${y}ë…„ ${m}ì›”`, '', '', '']);
      prevMonth = mk;
    }
    calRows.push([`${m}/${d}`, dow, a.dam || '', a.bidam || '']);
  });

  const ws1 = XLSX.utils.aoa_to_sheet(calRows);
  ws1['!cols'] = [{wch:8},{wch:5},{wch:10},{wch:10}];

  // í—¤ë” ìŠ¤íƒ€ì¼
  ['A1','B1','C1','D1'].forEach(cell => {
    if (ws1[cell]) ws1[cell].s = {
      fill: {fgColor: {rgb: '0ABAB5'}},
      font: {bold: true, color: {rgb: 'FFFFFF'}},
      alignment: {horizontal: 'center'}
    };
  });
  XLSX.utils.book_append_sheet(wb, ws1, 'ì›”ë³„ ë°°ì •í‘œ');

  // â”€â”€ ì‹œíŠ¸2: êµì‚¬ë³„ íšŸìˆ˜ ì§‘ê³„ â”€â”€
  const cnt = getCounts();
  const cntRows = [['ì´ë¦„', 'êµ¬ë¶„', 'ë°°ì • íšŸìˆ˜']];
  const dams   = state.teachers.filter(t => t.type === 'ë‹´ì„');
  const bidams = state.teachers.filter(t => t.type === 'ë¹„ë‹´ì„');
  dams.forEach(t   => cntRows.push([t.name, 'ë‹´ì„',   cnt[t.name] || 0]));
  bidams.forEach(t => cntRows.push([t.name, 'ë¹„ë‹´ì„', cnt[t.name] || 0]));

  const ws2 = XLSX.utils.aoa_to_sheet(cntRows);
  ws2['!cols'] = [{wch:10},{wch:8},{wch:10}];
  XLSX.utils.book_append_sheet(wb, ws2, 'êµì‚¬ë³„ íšŸìˆ˜');

  // â”€â”€ ì‹œíŠ¸3: êµì‚¬ë³„ ë°°ì •ì¼ ëª©ë¡ â”€â”€
  const teacherDates = {};
  state.teachers.forEach(t => { teacherDates[t.name] = []; });
  allKeys.forEach(key => {
    const [y,m,d] = key.split('-').map(Number);
    const a = assignments[key];
    const label = `${m}/${d}(${DAY_KR[new Date(y,m-1,d).getDay()]})`;
    if (a.dam   && teacherDates[a.dam])   teacherDates[a.dam].push(label);
    if (a.bidam && teacherDates[a.bidam]) teacherDates[a.bidam].push(label);
  });

  const tdRows = [['ì´ë¦„', 'êµ¬ë¶„', 'ë°°ì • ë‚ ì§œ ëª©ë¡']];
  [...dams, ...bidams].forEach(t => {
    tdRows.push([t.name, t.type, teacherDates[t.name].join(', ')]);
  });

  const ws3 = XLSX.utils.aoa_to_sheet(tdRows);
  ws3['!cols'] = [{wch:10},{wch:8},{wch:80}];
  XLSX.utils.book_append_sheet(wb, ws3, 'êµì‚¬ë³„ ë°°ì •ì¼');

  // íŒŒì¼ëª…: ë“±êµì§€ë„ë°°ì •_YYYYMMDD.xlsx
  const today = new Date();
  const fname = `ë“±êµì§€ë„ë°°ì •_${today.getFullYear()}${String(today.getMonth()+1).padStart(2,'0')}${String(today.getDate()).padStart(2,'0')}.xlsx`;
  XLSX.writeFile(wb, fname);
}


function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      state = JSON.parse(e.target.result);
      save();
      renderTeachers();
      renderCalendar();
      alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
    } catch { alert('íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function resetAll() {
  localStorage.setItem(STORAGE_KEY + '_backup', JSON.stringify(state));
  state = { teachers: [], assignments: {}, lastTeam: 'A', weekCount: 0, damBiweekUsed: [] };
  save();
  renderTeachers();
  renderCalendar();
  document.getElementById('restore-btn').style.display = 'flex';
  document.getElementById('reset-notice').style.display = 'block';
}

function restoreAll() {
  const raw = localStorage.getItem(STORAGE_KEY + '_backup');
  if (!raw) { alert('ë³µêµ¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  try {
    state = JSON.parse(raw);
    save();
    renderTeachers();
    renderCalendar();
    document.getElementById('restore-btn').style.display = 'none';
    document.getElementById('reset-notice').style.display = 'none';
  } catch { alert('ë³µêµ¬ ë°ì´í„°ê°€ ì†ìƒë˜ì—ˆìŠµë‹ˆë‹¤.'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
load();
renderTeachers();
renderCalendar();
updateEqualizeBtn();
</script>
</body>
</html>
