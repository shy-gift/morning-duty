<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>ë“±êµ ì§€ë„êµì‚¬ ì¡°íšŒ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --T: #0ABAB5; --TD: #007B78; --TP: #C8F0EE;
  --G: #C9A84C; --GL: #F5E8C8;
  --IV: #FAFAF8; --LG: #E8E8E8; --MG: #999; --CH: #2C2C2C;
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body { font-family: 'Noto Sans KR', sans-serif; background: var(--IV); color: var(--CH); min-height: 100vh; }

.hdr {
  background: linear-gradient(135deg, var(--TD), var(--T));
  color: #fff; padding: 16px 18px 12px; text-align: center;
  position: sticky; top: 0; z-index: 100;
  box-shadow: 0 2px 12px rgba(0,123,120,.3);
}
.hdr h1 { font-size: 17px; font-weight: 700; }
.hdr p  { font-size: 11px; opacity: .8; margin-top: 2px; }

/* URL ì„¤ì • í™”ë©´ */
#screen-url {
  display: flex; flex-direction: column; align-items: center;
  padding: 48px 24px; gap: 20px; max-width: 440px; margin: 0 auto;
}
.url-ico { font-size: 52px; }
.url-ttl { font-size: 18px; font-weight: 700; text-align: center; }
.url-desc { font-size: 13px; color: var(--MG); text-align: center; line-height: 1.7; }
.url-box {
  width: 100%; background: #fff; border-radius: 14px;
  padding: 16px; box-shadow: 0 2px 12px rgba(0,0,0,.07);
}
.url-box input {
  width: 100%; padding: 11px 13px; border: 1.5px solid var(--LG);
  border-radius: 10px; font-family: 'Noto Sans KR', sans-serif;
  font-size: 12px; outline: none; margin-bottom: 10px; display: block;
}
.url-box input:focus { border-color: var(--T); }
.url-btn {
  width: 100%; padding: 13px; background: var(--T); color: #fff;
  border: none; border-radius: 10px; font-family: 'Noto Sans KR', sans-serif;
  font-size: 14px; font-weight: 700; cursor: pointer;
}
.url-btn:active { background: var(--TD); }
.url-err { color: #e05c5c; font-size: 12px; text-align: center; display: none; margin-top: 8px; line-height: 1.6; }
.sample-btn {
  background: none; border: 1px solid var(--LG); border-radius: 20px;
  padding: 8px 20px; font-family: 'Noto Sans KR', sans-serif;
  font-size: 12px; color: var(--MG); cursor: pointer;
}

/* ë¡œë”© */
#screen-loading {
  display: none; flex-direction: column; align-items: center;
  justify-content: center; padding: 80px 24px; gap: 16px;
}
.spin {
  width: 40px; height: 40px; border: 3px solid var(--TP);
  border-top-color: var(--T); border-radius: 50%;
  animation: sp .8s linear infinite;
}
@keyframes sp { to { transform: rotate(360deg); } }
.loading-txt { font-size: 13px; color: var(--MG); }
.reset-btn {
  background: none; border: 1px solid var(--LG); border-radius: 8px;
  padding: 6px 14px; font-family: 'Noto Sans KR', sans-serif;
  font-size: 12px; color: var(--MG); cursor: pointer; margin-top: 4px;
}

/* ë©”ì¸ */
#screen-main { display: none; }

.banner {
  background: #fff; border-bottom: 1px solid var(--LG);
  padding: 7px 14px; display: flex; align-items: center;
  justify-content: space-between; font-size: 11px; color: var(--MG);
  gap: 8px;
}
.banner strong { color: var(--TD); }
.banner-btns { display: flex; gap: 6px; flex-shrink: 0; }
.rbtn {
  background: none; border: 1px solid var(--LG); border-radius: 6px;
  padding: 3px 9px; font-size: 11px; color: var(--MG);
  cursor: pointer; font-family: 'Noto Sans KR', sans-serif; white-space: nowrap;
}
.rbtn:hover { border-color: var(--T); color: var(--TD); }
.rbtn.danger { color: #e05c5c; border-color: #ffcdd2; }

.tabs {
  display: flex; background: #fff; border-bottom: 2px solid var(--LG);
  position: sticky; top: 57px; z-index: 90;
}
.tab {
  flex: 1; padding: 10px 0; background: none; border: none;
  font-family: 'Noto Sans KR', sans-serif; font-size: 13px;
  font-weight: 500; color: var(--MG); cursor: pointer;
  border-bottom: 2.5px solid transparent; margin-bottom: -2px;
}
.tab.on { color: var(--TD); border-bottom-color: var(--T); font-weight: 700; }

/* ë‹¬ë ¥ */
.cal-panel { padding: 12px 12px 60px; }
.cal-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
.cal-nav h2 { font-size: 18px; font-weight: 700; }
.nav-btn {
  width: 36px; height: 36px; border-radius: 9px; background: #fff;
  border: 1.5px solid var(--LG); font-size: 18px; font-weight: 700;
  color: var(--TD); cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.dow-row { display: grid; grid-template-columns: 44px repeat(5,1fr); gap: 3px; margin-bottom: 3px; }
.dow-cell { text-align: center; font-size: 11px; font-weight: 700; padding: 4px 0; color: var(--MG); }
.dow-cell:first-child { color: transparent; }
.week-row { display: grid; grid-template-columns: 44px repeat(5,1fr); gap: 3px; margin-bottom: 3px; }
.wlabel { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: var(--MG); }
.wlabel .wd { font-size: 12px; font-weight: 700; color: var(--CH); }
.day-cell { background: #fff; border: 1px solid var(--LG); border-radius: 8px; padding: 5px 5px 4px; min-height: 52px; }
.day-cell.today { border-color: var(--T); background: #f0fffe; }
.day-cell.off { background: #f5f5f5; display: flex; align-items: center; justify-content: center; }
.day-cell.empty { background: transparent; border-color: transparent; }
.day-cell.noasgn { background: #fafafa; }
.dnum { font-size: 11px; font-weight: 600; color: var(--MG); margin-bottom: 3px; display: flex; align-items: center; gap: 3px; }
.tdot { width: 5px; height: 5px; background: var(--T); border-radius: 50%; display: inline-block; }
.off-lbl { font-size: 10px; color: #ccc; }
.ntag { font-size: 10px; font-weight: 600; border-radius: 4px; padding: 2px 5px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.ntag.dam   { background: var(--TP); color: var(--TD); }
.ntag.bidam { background: var(--GL); color: #7a5a1a; }
.cal-sum { margin-top: 14px; background: #fff; border-radius: 12px; padding: 14px; }
.sum-ttl { font-size: 11px; font-weight: 700; color: var(--MG); margin-bottom: 8px; }
.sum-wrap { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
.schip { background: var(--IV); border: 1px solid var(--LG); border-radius: 20px; padding: 4px 10px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
.schip span { font-size: 10px; color: var(--MG); font-weight: 400; }
.schip.dam   { background: var(--TP); border-color: var(--T); color: var(--TD); }
.schip.bidam { background: var(--GL); border-color: var(--G); color: #7a5a1a; }

/* ê²€ìƒ‰ */
.srch-panel { padding: 12px 12px 60px; }
.srch-inp {
  width: 100%; padding: 11px 14px; border: 1.5px solid var(--LG);
  border-radius: 10px; font-family: 'Noto Sans KR', sans-serif;
  font-size: 14px; outline: none; margin-bottom: 12px; display: block;
}
.srch-inp:focus { border-color: var(--T); }
.chips { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 14px; }
.chip {
  padding: 5px 12px; border-radius: 20px; border: 1.5px solid var(--LG);
  background: #fff; font-family: 'Noto Sans KR', sans-serif;
  font-size: 12px; font-weight: 500; cursor: pointer; color: var(--CH);
}
.chip:active, .chip.on { background: var(--T); border-color: var(--T); color: #fff; }
.chip.b:active, .chip.b.on { background: var(--G); border-color: var(--G); color: #fff; }

.t-card { background: #fff; border-radius: 14px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
.t-top { display: flex; align-items: center; gap: 12px; border-left: 4px solid var(--T); padding-left: 12px; margin-bottom: 14px; }
.t-card.b .t-top { border-left-color: var(--G); }
.ava { width: 44px; height: 44px; border-radius: 12px; background: var(--TP); color: var(--TD); font-size: 18px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.ava.b { background: var(--GL); color: #7a5a1a; }
.t-info h2 { font-size: 15px; font-weight: 700; }
.t-info p  { font-size: 11px; color: var(--MG); margin-top: 2px; }
.t-cnt { margin-left: auto; background: var(--TP); color: var(--TD); border-radius: 20px; padding: 4px 12px; font-size: 12px; font-weight: 700; white-space: nowrap; }
.t-cnt.b { background: var(--GL); color: #7a5a1a; }
.nxt { display: flex; align-items: center; gap: 12px; background: var(--TP); border-radius: 12px; padding: 12px 14px; margin-bottom: 14px; }
.nxt.b { background: var(--GL); }
.nxt-txt { flex: 1; font-size: 12px; line-height: 1.6; }
.nxt-txt strong { font-size: 14px; font-weight: 700; color: var(--TD); }
.nxt.b .nxt-txt strong { color: #7a5a1a; }
.nxt-dd { font-size: 13px; font-weight: 700; color: var(--TD); background: #fff; border-radius: 8px; padding: 5px 10px; white-space: nowrap; }
.nxt.b .nxt-dd { color: #7a5a1a; }
.m-sec { margin-bottom: 12px; }
.m-ttl { font-size: 12px; font-weight: 700; color: var(--MG); margin-bottom: 7px; }
.d-chips { display: flex; flex-wrap: wrap; gap: 5px; }
.dc { padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 500; background: var(--IV); border: 1px solid var(--LG); color: var(--CH); }
.dc.today { background: var(--T); color: #fff; border-color: var(--T); }
.dc.soon  { background: var(--TP); color: var(--TD); border-color: var(--T); }
.dc.bsoon { background: var(--GL); color: #7a5a1a; border-color: var(--G); }
.dc.past  { color: #ccc; border-color: #eee; }
.empty-card { text-align: center; padding: 40px 20px; color: var(--MG); }
.empty-ico { font-size: 40px; margin-bottom: 10px; }
</style>
</head>
<body>

<div class="hdr">
  <h1>ğŸ“‹ ë“±êµ ì§€ë„êµì‚¬ ì¡°íšŒ</h1>
  <p id="hdr-sub">ë°°ì • ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>

<!-- â‘  URL ì…ë ¥ í™”ë©´ -->
<div id="screen-url">
  <div class="url-ico">ğŸ”—</div>
  <div class="url-ttl">ì›¹ì•± URLì„ ì…ë ¥í•´ ì£¼ì„¸ìš”</div>
  <div class="url-desc"><b>ìµœì´ˆ 1íšŒë§Œ</b> ì…ë ¥í•˜ë©´<br>ì´í›„ ìë™ìœ¼ë¡œ ìµœì‹  ë°°ì •í‘œë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</div>
  <div class="url-box">
    <input id="url-inp" type="url" placeholder="https://script.google.com/macros/s/.../exec"
      onkeydown="if(event.key==='Enter')connect()">
    <button class="url-btn" onclick="connect()">ğŸ”— ì—°ê²°í•˜ê¸°</button>
    <div id="url-err" class="url-err"></div>
  </div>
  <button class="sample-btn" onclick="loadSample()">ğŸ§ª ìƒ˜í”Œ ë°ì´í„°ë¡œ ë¯¸ë¦¬ë³´ê¸°</button>
</div>

<!-- â‘¡ ë¡œë”© í™”ë©´ -->
<div id="screen-loading">
  <div class="spin"></div>
  <div class="loading-txt">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
  <button class="reset-btn" onclick="resetUrl()">âš™ï¸ URL ì¬ì„¤ì •</button>
</div>

<!-- â‘¢ ë©”ì¸ í™”ë©´ -->
<div id="screen-main">
  <div class="banner">
    <span id="banner-txt" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>
    <div class="banner-btns">
      <button class="rbtn" id="rfbtn" onclick="refreshData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      <button class="rbtn danger" onclick="resetUrl()">URL ë³€ê²½</button>
    </div>
  </div>
  <div class="tabs">
    <button class="tab on" id="t-search" onclick="goTab('search')">ğŸ” êµì‚¬ ì¡°íšŒ</button>
    <button class="tab"    id="t-cal"    onclick="goTab('cal')">ğŸ“… ì›”ë³„ ë‹¬ë ¥</button>
  </div>

  <!-- ê²€ìƒ‰ íŒ¨ë„ -->
  <div id="p-search" class="srch-panel">
    <input id="srch-inp" class="srch-inp" type="text" placeholder="ì„ ìƒë‹˜ ì´ë¦„ ê²€ìƒ‰..."
      oninput="doSearch()" autocomplete="off">
    <div id="chips" class="chips"></div>
    <div id="result"></div>
  </div>

  <!-- ë‹¬ë ¥ íŒ¨ë„ -->
  <div id="p-cal" class="cal-panel" style="display:none">
    <div class="cal-nav">
      <button class="nav-btn" onclick="calMove(-1)">â€¹</button>
      <h2 id="cal-title"></h2>
      <button class="nav-btn" onclick="calMove(1)">â€º</button>
    </div>
    <div id="cal-body"></div>
    <div id="cal-sum" class="cal-sum" style="display:none"></div>
  </div>
</div>

<script>
var URL_KEY  = 'morningDutyGasUrl';
var DATA_KEY = 'morningDutyCache';
var DK = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
var S = null;
var curTab = 'search';
var calY = new Date().getFullYear();
var calM = new Date().getMonth() + 1;

function showScreen(n) {
  document.getElementById('screen-url').style.display     = n==='url'     ? 'flex'  : 'none';
  document.getElementById('screen-loading').style.display = n==='loading' ? 'flex'  : 'none';
  document.getElementById('screen-main').style.display    = n==='main'    ? 'block' : 'none';
}

// â”€â”€ XHR ë¡œë“œ (ê¸‰ì‹ì§€ë„ì™€ ë™ì¼) â”€â”€
function loadFromSheets(url, onOk, onFail) {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', url + '?action=load', true);
  xhr.onload = function() {
    try {
      var json = JSON.parse(xhr.responseText);
      if (json.success && json.data && json.data.teachers) {
        onOk(json.data);
      } else {
        onFail('ì„œë²„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë°°ì • ì•±ì—ì„œ ë¨¼ì € ì €ì¥í•´ ì£¼ì„¸ìš”.');
      }
    } catch(e) { onFail('ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜: ' + e.message); }
  };
  xhr.onerror = function() { onFail('ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì¸í„°ë„·ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.'); };
  xhr.send();
}

function connect() {
  var url = document.getElementById('url-inp').value.trim();
  var err = document.getElementById('url-err');
  err.style.display = 'none';
  if (!url) { err.textContent='URLì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; err.style.display='block'; return; }
  if (!url.includes('script.google.com')) { err.textContent='Apps Script URLì´ ì•„ë‹™ë‹ˆë‹¤.'; err.style.display='block'; return; }
  if (!url.endsWith('/exec')) { err.textContent='URLì´ /exec ë¡œ ëë‚˜ì•¼ í•©ë‹ˆë‹¤.'; err.style.display='block'; return; }

  localStorage.setItem(URL_KEY, url);
  showScreen('loading');
  loadFromSheets(url,
    function(data) {
      S = data;
      try { localStorage.setItem(DATA_KEY, JSON.stringify(data)); } catch(e) {}
      showMain();
    },
    function(msg) {
      showScreen('url');
      err.textContent = 'âŒ ' + msg;
      err.style.display = 'block';
    }
  );
}

function refreshData() {
  var url = localStorage.getItem(URL_KEY);
  if (!url) { resetUrl(); return; }
  var btn = document.getElementById('rfbtn');
  btn.textContent='â³'; btn.disabled=true;
  loadFromSheets(url,
    function(data) {
      S = data;
      try { localStorage.setItem(DATA_KEY, JSON.stringify(data)); } catch(e) {}
      applyData();
      if (curTab==='cal') renderCal();
      else { var nm=document.getElementById('srch-inp').value.trim(); if(nm) doSearch(); }
      btn.textContent='âœ…'; setTimeout(function(){ btn.textContent='ğŸ”„ ìƒˆë¡œê³ ì¹¨'; btn.disabled=false; }, 1500);
    },
    function() {
      btn.textContent='âŒ'; setTimeout(function(){ btn.textContent='ğŸ”„ ìƒˆë¡œê³ ì¹¨'; btn.disabled=false; }, 1500);
    }
  );
}

function resetUrl() {
  if (!confirm('URLì„ ë‹¤ì‹œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  localStorage.removeItem(URL_KEY);
  location.reload();
}

window.onload = function() {
  var savedUrl = localStorage.getItem(URL_KEY) || '';
  if (!savedUrl) { showScreen('url'); return; }
  document.getElementById('url-inp').value = savedUrl;

  // ìºì‹œ ìˆìœ¼ë©´ ë¨¼ì € í‘œì‹œ
  var cached = null;
  try { var r=localStorage.getItem(DATA_KEY); if(r){ var d=JSON.parse(r); if(d&&d.teachers&&d.assignments) cached=d; } } catch(e){}

  if (cached) {
    S = cached; showMain();
    // ë°±ê·¸ë¼ìš´ë“œ ê°±ì‹ 
    loadFromSheets(savedUrl,
      function(data){ S=data; try{localStorage.setItem(DATA_KEY,JSON.stringify(data));}catch(e){} applyData(); if(curTab==='cal') renderCal(); },
      function(){}
    );
  } else {
    showScreen('loading');
    loadFromSheets(savedUrl,
      function(data){ S=data; try{localStorage.setItem(DATA_KEY,JSON.stringify(data));}catch(e){} showMain(); },
      function(msg){
        showScreen('url');
        var err=document.getElementById('url-err');
        err.textContent='âŒ '+msg; err.style.display='block';
        document.getElementById('url-inp').value=savedUrl;
      }
    );
  }
};

function showMain() {
  showScreen('main'); applyData(); goTab('search');
}

function applyData() {
  var keys=Object.keys(S.assignments).filter(function(k){ return S.assignments[k]&&typeof S.assignments[k]==='object'; }).sort();
  if (keys.length) {
    var f=keys[0].split('-'), l=keys[keys.length-1].split('-');
    var rng=f[0]+'ë…„ '+(+f[1])+'ì›” ~ '+(+l[1])+'ì›”';
    document.getElementById('hdr-sub').textContent=rng+' ë°°ì •';
    var cur=calY+'-'+String(calM).padStart(2,'0');
    if(!keys.some(function(k){return k.startsWith(cur);})){calY=+l[0];calM=+l[1];}
    var bt='<strong>'+rng+'</strong> Â· '+keys.length+'ì¼';
    if(S._savedAt){var d=new Date(S._savedAt);bt+=' Â· <span style="color:var(--MG)">'+(d.getMonth()+1)+'/'+d.getDate()+'</span>';}
    document.getElementById('banner-txt').innerHTML=bt;
  }
  document.getElementById('chips').innerHTML=(S.teachers||[]).map(function(t){
    return '<button class="chip'+(t.type==='ë¹„ë‹´ì„'?' b':'')+'" onclick="pick(\''+t.name+'\')">'+t.name+'</button>';
  }).join('');
}

function goTab(tab) {
  curTab=tab;
  document.getElementById('p-search').style.display=tab==='search'?'':'none';
  document.getElementById('p-cal').style.display=tab==='cal'?'':'none';
  document.getElementById('t-search').classList.toggle('on',tab==='search');
  document.getElementById('t-cal').classList.toggle('on',tab==='cal');
  if(tab==='cal') renderCal();
}

function calMove(dir) { calM+=dir; if(calM>12){calM=1;calY++;} if(calM<1){calM=12;calY--;} renderCal(); }

function renderCal() {
  if(!S) return;
  document.getElementById('cal-title').textContent=calY+'ë…„ '+calM+'ì›”';
  var asgns=S.assignments||{}, today=new Date(); today.setHours(0,0,0,0);
  var dim=new Date(calY,calM,0).getDate();
  var html='<div class="dow-row"><div class="dow-cell"></div>';
  ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'].forEach(function(h){html+='<div class="dow-cell">'+h+'</div>';});
  html+='</div>';
  var weeks=[],week=[];
  for(var d=1;d<=dim;d++){var dow=new Date(calY,calM-1,d).getDay();if(dow===0||dow===6)continue;if(dow===1&&week.length){weeks.push(week);week=[];}week.push(d);}
  if(week.length) weeks.push(week);
  var damCnt={},bidamCnt={},total=0;
  weeks.forEach(function(wk){
    html+='<div class="week-row"><div class="wlabel"><div class="wd">'+wk[0]+'</div><div style="font-size:10px">~'+wk[wk.length-1]+'</div></div>';
    for(var dw=1;dw<=5;dw++){
      var day=wk.find(function(dd){return new Date(calY,calM-1,dd).getDay()===dw;});
      if(day===undefined){html+='<div class="day-cell empty"></div>';continue;}
      var key=calY+'-'+String(calM).padStart(2,'0')+'-'+String(day).padStart(2,'0');
      var asgn=asgns[key], isToday=new Date(calY,calM-1,day).getTime()===today.getTime();
      var cls='day-cell'+(isToday?' today':'');
      var inner='<div class="dnum">'+day+(isToday?'<span class="tdot"></span>':'')+'</div>';
      if(asgn==='off'){cls+=' off';inner='<div class="off-lbl">íœ´ë¬´</div>';}
      else if(asgn&&typeof asgn==='object'){
        total++;
        if(asgn.dam){damCnt[asgn.dam]=(damCnt[asgn.dam]||0)+1;inner+='<div class="ntag dam">'+asgn.dam+'</div>';}
        if(asgn.bidam){bidamCnt[asgn.bidam]=(bidamCnt[asgn.bidam]||0)+1;inner+='<div class="ntag bidam">'+asgn.bidam+'</div>';}
      } else {cls+=' noasgn';}
      html+='<div class="'+cls+'">'+inner+'</div>';
    }
    html+='</div>';
  });
  document.getElementById('cal-body').innerHTML=html;
  var sumEl=document.getElementById('cal-sum');
  if(!total){sumEl.style.display='none';return;}
  sumEl.style.display='';
  var mk=function(n,c,t){return '<span class="schip '+t+'">'+n+'<span>'+c+'íšŒ</span></span>';};
  var dE=Object.entries(damCnt).sort(function(a,b){return b[1]-a[1];});
  var bE=Object.entries(bidamCnt).sort(function(a,b){return b[1]-a[1];});
  sumEl.innerHTML='<div class="sum-ttl">â–ª ë‹´ì„</div><div class="sum-wrap">'+(dE.length?dE.map(function(e){return mk(e[0],e[1],'dam');}).join(''):'<span style="color:#ccc;font-size:11px">ì—†ìŒ</span>')+'</div><div class="sum-ttl">â–ª ë¹„ë‹´ì„</div><div class="sum-wrap">'+(bE.length?bE.map(function(e){return mk(e[0],e[1],'bidam');}).join(''):'<span style="color:#ccc;font-size:11px">ì—†ìŒ</span>')+'</div>';
}

function pick(name){ document.getElementById('srch-inp').value=name; doSearch(); }

function doSearch(){
  var name=document.getElementById('srch-inp').value.trim();
  var resEl=document.getElementById('result');
  if(!name||!S){resEl.innerHTML='';return;}
  document.querySelectorAll('.chip').forEach(function(c){c.classList.toggle('on',c.textContent===name);});
  var t=(S.teachers||[]).find(function(t){return t.name===name;});
  if(!t){resEl.innerHTML='<div class="empty-card"><div class="empty-ico">ğŸ¤”</div><p>'+name+' ì„ ìƒë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>';return;}
  var today=new Date();today.setHours(0,0,0,0);
  var my=[];
  Object.keys(S.assignments||{}).sort().forEach(function(key){
    var a=S.assignments[key];
    if(!a||typeof a!=='object')return;
    if(a.dam===name||a.bidam===name){
      var p=key.split('-').map(Number),dt=new Date(p[0],p[1]-1,p[2]);dt.setHours(0,0,0,0);
      my.push({y:p[0],m:p[1],d:p[2],dt:dt,diff:Math.round((dt-today)/86400000)});
    }
  });
  var isB=t.type==='ë¹„ë‹´ì„';
  var nxt=my.filter(function(x){return x.diff>=0;}).sort(function(a,b){return a.diff-b.diff;})[0]||null;
  var byM={};
  my.forEach(function(x){var k=x.y+'-'+String(x.m).padStart(2,'0');if(!byM[k])byM[k]=[];byM[k].push(x);});
  var h='<div class="t-card'+(isB?' b':'')+'"><div class="t-top"><div class="ava'+(isB?' b':'')+'">'+t.name[0]+'</div><div class="t-info"><h2>'+t.name+' ì„ ìƒë‹˜</h2><p>'+t.type+(t.team?' Â· '+t.team+'íŒ€':'')+'</p></div><div class="t-cnt'+(isB?' b':'')+'">ì´ '+my.length+'íšŒ</div></div>';
  if(nxt){
    var ds=nxt.diff===0?'ì˜¤ëŠ˜!':nxt.diff===1?'ë‚´ì¼':'D-'+nxt.diff;
    h+='<div class="nxt'+(isB?' b':'')+'"><span style="font-size:20px">ğŸ“…</span><div class="nxt-txt">ë‹¤ìŒ ë“±êµì§€ë„<br><strong>'+nxt.m+'ì›” '+nxt.d+'ì¼ ('+DK[nxt.dt.getDay()]+')</strong></div><div class="nxt-dd">'+ds+'</div></div>';
  } else {
    h+='<div class="nxt" style="background:#f5f5f5"><span>âœ…</span><div class="nxt-txt" style="color:var(--MG)">ì´ë²ˆ ë°°ì • ê¸°ê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</div></div>';
  }
  Object.keys(byM).sort().forEach(function(mk){
    var p=mk.split('-');
    h+='<div class="m-sec"><div class="m-ttl">'+p[0]+'ë…„ '+(+p[1])+'ì›”</div><div class="d-chips">';
    byM[mk].forEach(function(x){
      var cls=x.diff===0?'today':x.diff<0?'past':x.diff<=7?(isB?'bsoon':'soon'):'';
      h+='<div class="dc '+cls+'">'+x.m+'/'+x.d+'('+DK[x.dt.getDay()]+')</div>';
    });
    h+='</div></div>';
  });
  h+='</div>';
  resEl.innerHTML=h;
}

function loadSample(){
  var y=new Date().getFullYear(),m=new Date().getMonth()+1;
  var dA=['ì´ì±„ë ¹','ê¹€ì˜ìˆ˜','ë°•ë¯¼ì¤€','ìµœìˆ˜ì§„','ì •í•˜ì€'],dB=['ì˜¤ë‚œê²½','ì´ì •í˜¸','ê°•ë¯¼ì•„','í•œì§€ì›','ë¥˜ìŠ¹í˜„'],bi=['ì •ìš©ì±„','ì´ë¯¼ìˆ˜','ìµœìœ¤ì˜','ì •ë‹¤ì˜','ë°±ì¤€ê¸°'];
  var asgns={},aI=0,bI=0,biI=0,wk=0,tm='A',wd=0,dim=new Date(y,m,0).getDate();
  for(var d=1;d<=dim;d++){var dow=new Date(y,m-1,d).getDay();if(dow===0||dow===6)continue;if(wd>0&&wd%5===0){wk++;if(wk%2===0){tm=tm==='A'?'B':'A';aI=0;bI=0;}}var key=y+'-'+String(m).padStart(2,'0')+'-'+String(d).padStart(2,'0');var pool=tm==='A'?dA:dB;asgns[key]={dam:pool[(tm==='A'?aI++:bI++)%pool.length],bidam:bi[biI++%bi.length]};wd++;}
  S={teachers:dA.map(function(n){return{name:n,type:'ë‹´ì„',team:'A'};}).concat(dB.map(function(n){return{name:n,type:'ë‹´ì„',team:'B'};})).concat(bi.map(function(n){return{name:n,type:'ë¹„ë‹´ì„'};})),assignments:asgns,_savedAt:new Date().toISOString()};
  showMain();
}
</script>
</body>
</html>
