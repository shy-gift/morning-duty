<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>ë“±êµ ì§€ë„êµì‚¬ ì¡°íšŒ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --T:  #0ABAB5;
  --TD: #007B78;
  --TP: #C8F0EE;
  --G:  #C9A84C;
  --GL: #F5E8C8;
  --IV: #FAFAF8;
  --LG: #E8E8E8;
  --MG: #999;
  --CH: #2C2C2C;
  --RE: #e05c5c;
  --BL: #5c7ee0;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Noto Sans KR', sans-serif; background: var(--IV); color: var(--CH); }

/* í—¤ë” */
.hdr {
  background: linear-gradient(135deg, var(--TD), var(--T));
  color: #fff; padding: 16px 18px 13px; text-align: center;
  position: sticky; top: 0; z-index: 100;
  box-shadow: 0 2px 12px rgba(0,123,120,.3);
}
.hdr h1 { font-size: 17px; font-weight: 700; }
.hdr p  { font-size: 11px; opacity: .8; margin-top: 2px; }

/* íƒ­ */
.tabs {
  display: flex; background: #fff;
  border-bottom: 2px solid var(--LG);
  position: sticky; top: 57px; z-index: 90;
}
.tab {
  flex: 1; padding: 10px 0; background: none; border: none;
  font-family: 'Noto Sans KR', sans-serif; font-size: 13px;
  font-weight: 500; color: var(--MG); cursor: pointer;
  border-bottom: 2.5px solid transparent; margin-bottom: -2px;
}
.tab.on { color: var(--TD); border-bottom-color: var(--T); font-weight: 700; }

/* ë°ì´í„° ë°°ë„ˆ */
.banner {
  background: #fff; border-bottom: 1px solid var(--LG);
  padding: 7px 14px; display: flex; align-items: center;
  justify-content: space-between; font-size: 11px; color: var(--MG);
}
.banner strong { color: var(--TD); }
.reload { background: none; border: 1px solid var(--LG); border-radius: 6px;
  padding: 3px 9px; font-size: 11px; color: var(--MG); cursor: pointer; font-family: 'Noto Sans KR', sans-serif; }
.reload:hover { border-color: var(--T); color: var(--TD); }

/* â”€â”€ ë‹¬ë ¥ íŒ¨ë„ â”€â”€ */
.cal-panel { padding: 12px 12px 40px; }

.cal-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
.cal-nav h2 { font-size: 18px; font-weight: 700; }
.nav-btn {
  width: 36px; height: 36px; border-radius: 9px; background: #fff;
  border: 1.5px solid var(--LG); font-size: 20px; font-weight: 700;
  color: var(--TD); cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.nav-btn:hover { background: var(--TP); border-color: var(--T); }

/* ë‹¬ë ¥: ìš”ì¼ í—¤ë” */
.dow-row {
  display: grid; grid-template-columns: 48px repeat(5, 1fr);
  gap: 3px; margin-bottom: 3px;
}
.dow-cell {
  text-align: center; font-size: 11px; font-weight: 700;
  padding: 4px 0; color: var(--MG);
}
.dow-cell:nth-child(1) { color: transparent; }

/* ì£¼ê°„ í–‰ */
.week-row {
  display: grid; grid-template-columns: 48px repeat(5, 1fr);
  gap: 3px; margin-bottom: 3px;
}
/* ë‚ ì§œ ë¼ë²¨ */
.week-label {
  display: flex; flex-direction: column; gap: 2px;
  justify-content: center; align-items: center;
  font-size: 10px; color: var(--MG); padding: 4px 2px;
}
.week-label .wl-d { font-size: 13px; font-weight: 700; color: var(--CH); line-height: 1; }
.week-label .wl-w { font-size: 10px; color: var(--MG); }

/* ë°°ì • ì…€ */
.day-cell {
  background: #fff; border: 1px solid var(--LG);
  border-radius: 8px; padding: 6px 6px 5px;
  min-height: 58px; display: flex; flex-direction: column; gap: 3px;
}
.day-cell.today   { border: 2px solid var(--T); background: #edfaf9; }
.day-cell.off     { background: #f3f3f3; justify-content: center; align-items: center; }
.day-cell.no-asgn { background: #fafafa; }
.day-cell.empty   { background: none; border-color: transparent; }

.day-num {
  font-size: 11px; font-weight: 700; color: var(--CH);
  display: flex; align-items: center; gap: 2px; line-height: 1;
}
.today-dot { width: 4px; height: 4px; border-radius: 50%; background: var(--T); flex-shrink: 0; }

/* ì´ë¦„ íƒœê·¸ */
.name-tag {
  border-radius: 5px; padding: 3px 6px;
  font-size: 11px; font-weight: 600; line-height: 1.3;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.name-tag.dam   { background: var(--TP); color: var(--TD); }
.name-tag.bidam { background: var(--GL); color: #7a5a00; }
.off-label { font-size: 10px; color: #bbb; }

/* ë²”ë¡€ */
.legend { display: flex; gap: 14px; margin-bottom: 8px; }
.leg-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--MG); }
.leg-dot { width: 8px; height: 8px; border-radius: 50%; }

/* ì´ë‹¬ ìš”ì•½ */
.monthly-sum {
  margin-top: 14px; background: #fff; border-radius: 12px;
  padding: 13px 14px; box-shadow: 0 1px 6px rgba(0,0,0,.06);
}
.sum-ttl { font-size: 11px; font-weight: 700; color: var(--MG); margin-bottom: 7px; }
.sum-ttl:not(:first-child) { margin-top: 12px; }
.sum-wrap { display: flex; flex-wrap: wrap; gap: 4px; }
.sum-chip {
  border-radius: 6px; padding: 3px 10px;
  font-size: 11px; font-weight: 600; display: inline-flex; gap: 4px;
}
.sum-chip.dam   { background: var(--TP); color: var(--TD); }
.sum-chip.bidam { background: var(--GL); color: #7a5a00; }
.sum-chip span  { font-weight: 400; opacity: .7; font-size: 10px; }

/* â”€â”€ êµì‚¬ ì¡°íšŒ íŒ¨ë„ â”€â”€ */
.srch-area { padding: 12px 14px 8px; background: #fff; border-bottom: 1px solid var(--LG); }
.srch-row  { display: flex; gap: 8px; }
.srch-inp {
  flex: 1; padding: 11px 14px; border: 1.5px solid var(--LG);
  border-radius: 10px; font-family: 'Noto Sans KR', sans-serif;
  font-size: 15px; background: var(--IV); outline: none;
}
.srch-inp:focus { border-color: var(--T); }
.srch-btn {
  padding: 0 18px; background: var(--T); color: #fff;
  border: none; border-radius: 10px;
  font-family: 'Noto Sans KR', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer;
}
.srch-btn:hover { background: var(--TD); }
.chips { padding: 8px 14px 4px; display: flex; flex-wrap: wrap; gap: 6px; }
.chip {
  padding: 5px 12px; border-radius: 20px; border: 1.5px solid var(--T);
  background: #fff; color: var(--TD); font-size: 12px; font-weight: 500; cursor: pointer;
}
.chip:hover,.chip.on { background: var(--T); color: #fff; }
.chip.b { border-color: var(--G); color: #7a5a00; }
.chip.b:hover,.chip.b.on { background: var(--G); color: #fff; }
.res-area { padding: 14px; }
.empty { text-align: center; padding: 46px 20px; color: var(--MG); }
.empty-ico { font-size: 42px; margin-bottom: 10px; }
.empty p { font-size: 14px; line-height: 1.8; }

/* êµì‚¬ ì¹´ë“œ */
.t-card { background: #fff; border-radius: 14px; padding: 14px; border-left: 4px solid var(--T); box-shadow: 0 2px 10px rgba(0,0,0,.07); }
.t-card.b { border-left-color: var(--G); }
.t-top { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.ava { width: 40px; height: 40px; border-radius: 50%; background: var(--TP); color: var(--TD); display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; }
.ava.b { background: var(--GL); color: #7a5a00; }
.t-info h2 { font-size: 16px; font-weight: 700; }
.t-info p  { font-size: 12px; color: var(--MG); margin-top: 1px; }
.t-cnt { margin-left: auto; background: var(--TP); color: var(--TD); border-radius: 20px; padding: 4px 13px; font-size: 14px; font-weight: 700; }
.t-cnt.b { background: var(--GL); color: #7a5a00; }
.nxt {
  border-radius: 10px; padding: 9px 13px; margin-bottom: 10px;
  display: flex; align-items: center; gap: 8px; background: var(--TP);
}
.nxt.b { background: var(--GL); }
.nxt-txt { font-size: 13px; line-height: 1.5; }
.nxt-txt strong { color: var(--TD); font-size: 15px; }
.nxt.b .nxt-txt strong { color: #7a5a00; }
.nxt-dd { margin-left: auto; font-size: 13px; font-weight: 700; color: var(--TD); white-space: nowrap; }
.nxt.b .nxt-dd { color: #7a5a00; }
.m-sec { margin-bottom: 8px; }
.m-ttl { font-size: 12px; font-weight: 600; color: var(--MG); margin-bottom: 5px; }
.d-chips { display: flex; flex-wrap: wrap; gap: 5px; }
.d-chip { padding: 4px 9px; border-radius: 7px; font-size: 12px; font-weight: 500; background: var(--IV); border: 1px solid var(--LG); }
.d-chip.today { background: var(--T); color: #fff; border-color: var(--T); }
.d-chip.past  { opacity: .4; }
.d-chip.soon  { border-color: var(--T); color: var(--TD); font-weight: 700; }
.d-chip.bsoon { border-color: var(--G); color: #7a5a00; font-weight: 700; }

/* â”€â”€ ë¡œë”© í™”ë©´ â”€â”€ */
#loading {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; padding: 60px 22px; text-align: center;
}
.spin {
  width: 44px; height: 44px; border-radius: 50%;
  border: 4px solid var(--TP); border-top-color: var(--T);
  animation: spin 0.8s linear infinite; margin-bottom: 16px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-txt { font-size: 14px; color: var(--MG); line-height: 1.8; }

/* â”€â”€ ì—ëŸ¬/ìˆ˜ë™ ë¡œë“œ í™”ë©´ â”€â”€ */
#start {
  display: flex; flex-direction: column; align-items: center;
  padding: 50px 22px 40px; text-align: center;
}
.st-ico { font-size: 50px; margin-bottom: 14px; }
.st-ttl { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
.st-desc { font-size: 13px; color: var(--MG); line-height: 1.8; margin-bottom: 24px; }
.steps {
  background: #fff; border-radius: 14px; padding: 16px 18px;
  text-align: left; width: 100%; max-width: 340px;
  box-shadow: 0 2px 10px rgba(0,0,0,.07); margin-bottom: 22px;
}
.step { display: flex; gap: 11px; margin-bottom: 13px; }
.step:last-child { margin-bottom: 0; }
.step-n {
  width: 22px; height: 22px; border-radius: 50%; background: var(--T); color: #fff;
  font-size: 12px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.step-t { font-size: 13px; line-height: 1.6; }
.step-t b { color: var(--TD); }
.load-btn {
  background: var(--T); color: #fff; border: none;
  padding: 14px 32px; border-radius: 12px;
  font-family: 'Noto Sans KR', sans-serif; font-size: 15px; font-weight: 700;
  cursor: pointer; box-shadow: 0 4px 14px rgba(10,186,181,.35); margin-bottom: 10px;
}
.load-btn:hover { background: var(--TD); }
.smpl-btn {
  background: none; border: 1.5px dashed var(--LG); border-radius: 10px;
  padding: 9px 18px; font-family: 'Noto Sans KR', sans-serif; font-size: 12px;
  color: var(--MG); cursor: pointer; margin-top: 8px;
}
.smpl-btn:hover { border-color: var(--T); color: var(--TD); }
#file-inp { display: none; }
</style>
</head>
<body>

<div class="hdr">
  <h1>ğŸ“‹ ë“±êµ ì§€ë„êµì‚¬ ì¡°íšŒ</h1>
  <p id="hdr-sub">ë°°ì • ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>

<!-- ë¡œë”© í™”ë©´ (URL ìˆì„ ë•Œë§Œ í‘œì‹œ) -->
<div id="loading" style="display:none">
  <div class="spin"></div>
  <div class="loading-txt">ë°°ì • ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
  <button onclick="forceReset()" style="margin-top:20px;background:none;border:1px solid var(--LG);
    border-radius:8px;padding:7px 16px;font-family:'Noto Sans KR',sans-serif;
    font-size:12px;color:var(--MG);cursor:pointer;">âš™ï¸ URL ì¬ì„¤ì •</button>
</div>

<!-- URL ì…ë ¥ í™”ë©´ (ê¸°ë³¸ í‘œì‹œ) -->
<div id="start">
  <div class="st-ico">ğŸ”—</div>
  <div class="st-ttl">ì›¹ì•± URLì„ ì…ë ¥í•´ ì£¼ì„¸ìš”</div>
  <div class="st-desc"><b>ìµœì´ˆ 1íšŒë§Œ</b> ì…ë ¥í•˜ë©´<br>ì´í›„ì—ëŠ” ìë™ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.</div>
  <div class="steps">
    <div class="step">
      <div class="step-n">1</div>
      <div class="step-t">êµ¬ê¸€ ì‹œíŠ¸ â†’ í™•ì¥ í”„ë¡œê·¸ë¨ â†’ Apps Script<br>â†’ <b>ë°°í¬ â†’ ì›¹ì•± URL ë³µì‚¬</b></div>
    </div>
    <div class="step">
      <div class="step-n">2</div>
      <div class="step-t">ì•„ë˜ ì¹¸ì— ë¶™ì—¬ë„£ê¸° í›„ <b>ì—°ê²° ë²„íŠ¼</b> í´ë¦­</div>
    </div>
  </div>
  <div style="width:100%;max-width:360px;padding:0 4px">
    <input id="url-input" type="url"
      placeholder="https://script.google.com/macros/s/..."
      style="width:100%;padding:12px 14px;border:1.5px solid var(--LG);border-radius:10px;
             font-family:'Noto Sans KR',sans-serif;font-size:12px;margin-bottom:8px;
             background:#fff;outline:none;box-sizing:border-box;display:block;"
      onfocus="this.style.borderColor='var(--T)'"
      onblur="this.style.borderColor='var(--LG)'"
      onkeydown="if(event.key==='Enter')connect()">
    <div id="url-error" style="color:#e05c5c;font-size:12px;margin-bottom:8px;display:none;text-align:center"></div>
    <button class="load-btn" style="width:100%;" onclick="connect()">ğŸ”— ì—°ê²°í•˜ê¸°</button>
  </div>
  <button class="smpl-btn" onclick="loadSample()">ğŸ§ª ìƒ˜í”Œ ë°ì´í„°ë¡œ ë¯¸ë¦¬ë³´ê¸°</button>
</div>
<input type="file" id="file-inp" accept=".json" onchange="onFile(event)">

<!-- ë©”ì¸ í™”ë©´ -->
<div id="main" style="display:none">
  <div class="banner">
    <span id="banner-txt">ë°ì´í„° ë¡œë“œë¨</span>
    <div style="display:flex;gap:6px">
      <button class="reload" onclick="refreshData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      <button class="reload" onclick="resetURL()" style="color:#e05c5c;border-color:#ffcdd2">URLë³€ê²½</button>
    </div>
  </div>
  <div class="tabs">
    <button class="tab on" id="t-search" onclick="go('search')">ğŸ” êµì‚¬ ì¡°íšŒ</button>
    <button class="tab"    id="t-cal"    onclick="go('cal')">ğŸ“… ì›”ë³„ ë‹¬ë ¥</button>
  </div>

  <!-- ë‹¬ë ¥ íŒ¨ë„ -->
  <div id="p-cal" style="display:none">
    <div class="cal-panel">
      <div class="cal-nav">
        <button class="nav-btn" onclick="calMove(-1)">&#8249;</button>
        <h2 id="cal-title"></h2>
        <button class="nav-btn" onclick="calMove(1)">&#8250;</button>
      </div>
      <div class="legend">
        <div class="leg-item"><div class="leg-dot" style="background:var(--T)"></div>ë‹´ì„</div>
        <div class="leg-item"><div class="leg-dot" style="background:var(--G)"></div>ë¹„ë‹´ì„</div>
      </div>
      <div id="cal-body"></div>
      <div class="monthly-sum" id="cal-sum" style="display:none"></div>
    </div>
  </div>

  <!-- êµì‚¬ ì¡°íšŒ íŒ¨ë„ -->
  <div id="p-search">
    <div class="srch-area">
      <div class="srch-row">
        <input class="srch-inp" id="srch-inp" type="text" placeholder="ì´ë¦„ ì…ë ¥ (ì˜ˆ: ì´ì±„ë ¹)"
          onkeydown="if(event.key==='Enter')doSearch()">
        <button class="srch-btn" onclick="doSearch()">ì¡°íšŒ</button>
      </div>
    </div>
    <div class="chips" id="chips"></div>
    <div class="res-area" id="res">
      <div class="empty"><div class="empty-ico">ğŸ”</div><p>ì´ë¦„ì„ ê²€ìƒ‰í•˜ê±°ë‚˜<br>ìœ„ì˜ ì´ë¦„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p></div>
    </div>
  </div>
</div>

<script>

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì„¤ì • (ê¸‰ì‹ì§€ë„ì™€ ë™ì¼í•œ ë°©ì‹)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var URL_KEY  = 'morningDutyGasUrl';    // ì›¹ì•± URL
var DATA_KEY = 'morningDutyCached';    // ìºì‹œ

var DK = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
var S = null;
var curTab = 'search';
var calY = new Date().getFullYear();
var calM = new Date().getMonth() + 1;

// â”€â”€ XHRë¡œ ë°ì´í„° ë¡œë“œ (ê¸‰ì‹ì§€ë„ì™€ ë™ì¼í•œ ë°©ì‹) â”€â”€
function loadFromSheets(url) {
  showLoading(true);
  var xhr = new XMLHttpRequest();
  xhr.open('GET', url + '?action=load', true);
  xhr.onload = function() {
    try {
      var json = JSON.parse(xhr.responseText);
      if (json.success && json.data && json.data.teachers) {
        S = json.data;
        try { localStorage.setItem(DATA_KEY, JSON.stringify(S)); } catch(e) {}
        showMain();
      } else {
        // ì„œë²„ì— ë°ì´í„° ì—†ìŒ â†’ ìºì‹œ ì‹œë„
        var cached = loadFromCache();
        if (cached) {
          S = cached;
          showMain();
          showCacheBadge();
        } else {
          showError('ì„œë²„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë°°ì • ì•±ì—ì„œ ë¨¼ì € ì €ì¥í•´ ì£¼ì„¸ìš”.');
        }
      }
    } catch(e) {
      var cached = loadFromCache();
      if (cached) {
        S = cached;
        showMain();
        showCacheBadge();
      } else {
        showError('ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜: ' + e.message);
      }
    }
  };
  xhr.onerror = function() {
    var cached = loadFromCache();
    if (cached) {
      S = cached;
      showMain();
      showCacheBadge();
    } else {
      showError('ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
    }
  };
  xhr.send();
}

function loadFromCache() {
  try {
    var raw = localStorage.getItem(DATA_KEY);
    if (!raw) return null;
    var d = JSON.parse(raw);
    return (d && d.teachers && d.assignments) ? d : null;
  } catch(e) { return null; }
}

function showLoading(on) {
  document.getElementById('loading').style.display = on ? 'flex' : 'none';
}

function showCacheBadge() {
  setTimeout(function() {
    var el = document.getElementById('banner-txt');
    if (el) el.innerHTML += ' <span style="color:#e86826;font-size:10px">âš ï¸ìºì‹œ</span>';
  }, 100);
}

function showError(msg) {
  showLoading(false);
  document.getElementById('start').style.display = 'flex';
  var errEl = document.getElementById('url-error');
  if (errEl) { errEl.textContent = msg; errEl.style.display = 'block'; }
}

// â”€â”€ URL ì—°ê²° ë²„íŠ¼ â”€â”€
function connect() {
  var input = document.getElementById('url-input');
  var errEl = document.getElementById('url-error');
  var url   = input.value.trim();

  if (!url) {
    errEl.textContent = 'URLì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
    errEl.style.display = 'block';
    return;
  }
  if (!url.includes('script.google.com')) {
    errEl.textContent = 'Apps Script URLì´ ì•„ë‹™ë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.';
    errEl.style.display = 'block';
    return;
  }
  if (!url.endsWith('/exec')) {
    errEl.textContent = 'URLì´ /exec ë¡œ ëë‚˜ì•¼ í•©ë‹ˆë‹¤.';
    errEl.style.display = 'block';
    return;
  }

  errEl.style.display = 'none';
  document.getElementById('start').style.display = 'none';
  localStorage.setItem(URL_KEY, url);
  loadFromSheets(url);
}

// â”€â”€ ìƒˆë¡œê³ ì¹¨ â”€â”€
function refreshData() {
  var url = localStorage.getItem(URL_KEY);
  if (!url) { location.reload(); return; }
  var btn = document.querySelector('.reload');
  if (btn) { btn.textContent = 'â³...'; btn.disabled = true; }

  var xhr = new XMLHttpRequest();
  xhr.open('GET', url + '?action=load', true);
  xhr.onload = function() {
    try {
      var json = JSON.parse(xhr.responseText);
      if (json.success && json.data && json.data.teachers) {
        S = json.data;
        try { localStorage.setItem(DATA_KEY, JSON.stringify(S)); } catch(e) {}
        applyData();
        if (curTab === 'cal') renderCal();
        else { var nm = document.getElementById('srch-inp').value.trim(); if (nm) doSearch(); }
        if (btn) { btn.textContent = 'âœ… ì™„ë£Œ'; setTimeout(function(){ btn.textContent='ğŸ”„ ìƒˆë¡œê³ ì¹¨'; btn.disabled=false; }, 1500); }
      } else {
        if (btn) { btn.textContent = 'âš ï¸ ë°ì´í„°ì—†ìŒ'; setTimeout(function(){ btn.textContent='ğŸ”„ ìƒˆë¡œê³ ì¹¨'; btn.disabled=false; }, 1500); }
      }
    } catch(e) {
      if (btn) { btn.textContent = 'âŒ ì‹¤íŒ¨'; setTimeout(function(){ btn.textContent='ğŸ”„ ìƒˆë¡œê³ ì¹¨'; btn.disabled=false; }, 1500); }
    }
  };
  xhr.onerror = function() {
    if (btn) { btn.textContent = 'âŒ ì‹¤íŒ¨'; setTimeout(function(){ btn.textContent='ğŸ”„ ìƒˆë¡œê³ ì¹¨'; btn.disabled=false; }, 1500); }
  };
  xhr.send();
}

// â”€â”€ URL ì¬ì„¤ì • â”€â”€
function resetURL() {
  if (!confirm('ì›¹ì•± URLì„ ë‹¤ì‹œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  localStorage.removeItem(URL_KEY);
  location.reload();
}

// â”€â”€ ì´ˆê¸° ì‹¤í–‰ â”€â”€
window.onload = function() {
  var savedUrl = localStorage.getItem(URL_KEY) || '';

  if (savedUrl) {
    document.getElementById('url-input').value = savedUrl;
    // ìºì‹œ ë¨¼ì € ë³´ì—¬ì£¼ê³  â†’ ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ë¡œë“œ
    var cached = loadFromCache();
    if (cached) {
      S = cached;
      showMain();
    }
    loadFromSheets(savedUrl);
  } else {
    showLoading(false);
    document.getElementById('start').style.display = 'flex';
  }
};

/* íŒŒì¼ ì§ì ‘ ë¡œë“œ */
function onFile(e) {
  var f = e.target.files[0];
  if (!f) return;
  var r = new FileReader();
  r.onload = function(ev) {
    try {
      var d = JSON.parse(ev.target.result);
      if (!d.teachers || !d.assignments) { alert('ì˜¬ë°”ë¥¸ ë°°ì • ë°ì´í„° íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.'); return; }
      S = d; showMain();
    } catch(err) { alert('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); }
  };
  r.readAsText(f); e.target.value = '';
}

/* ìƒ˜í”Œ ë°ì´í„° */
function loadSample() {
  var now = new Date();
  var y = now.getFullYear(), m = now.getMonth() + 1;
  var dA=['ì´ì±„ë ¹','ê¹€ì˜ìˆ˜','ë°•ë¯¼ì¤€','ìµœìˆ˜ì§„','ì •í•˜ì€'];
  var dB=['ì˜¤ë‚œê²½','ì´ì •í˜¸','ê°•ë¯¼ì•„','í•œì§€ì›','ë¥˜ìŠ¹í˜„'];
  var bi=['ì •ìš©ì±„','ì´ë¯¼ìˆ˜','ìµœìœ¤ì˜','ì •ë‹¤ì˜','ë°±ì¤€ê¸°'];
  var asgns={}, aI=0, bI=0, biI=0, wk=0, tm='A', wd=0;
  var dim=new Date(y,m,0).getDate();
  for(var d=1;d<=dim;d++){
    var dt=new Date(y,m-1,d), dow=dt.getDay();
    if(dow===0||dow===6) continue;
    if(wd>0&&wd%5===0){wk++;if(wk%2===0){tm=tm==='A'?'B':'A';aI=0;bI=0;}}
    var key=y+'-'+String(m).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    var pool=tm==='A'?dA:dB;
    asgns[key]={dam:pool[(tm==='A'?aI++:bI++)%pool.length],bidam:bi[biI++%bi.length]};
    wd++;
  }
  S={teachers:
    dA.map(function(n){return{name:n,type:'ë‹´ì„',team:'A'};}).concat(
    dB.map(function(n){return{name:n,type:'ë‹´ì„',team:'B'};})).concat(
    bi.map(function(n){return{name:n,type:'ë¹„ë‹´ì„'};})),
    assignments:asgns,_savedAt:new Date().toISOString()};
  showMain();
}

/* ë©”ì¸ í™”ë©´ í‘œì‹œ */
function showMain() {
  showLoading(false);
  document.getElementById('start').style.display = 'none';
  document.getElementById('main').style.display  = '';
  applyData();
  go('search');
}

function applyData() {
  var keys = Object.keys(S.assignments).filter(function(k){
    return S.assignments[k] && typeof S.assignments[k]==='object';
  }).sort();
  if (keys.length) {
    var f=keys[0].split('-'), l=keys[keys.length-1].split('-');
    var rng=f[0]+'ë…„ '+(+f[1])+'ì›” ~ '+l[0]+'ë…„ '+(+l[1])+'ì›”';
    document.getElementById('banner-txt').innerHTML='<strong>'+rng+'</strong> Â· '+keys.length+'ì¼';
    document.getElementById('hdr-sub').textContent=rng+' ë°°ì •';
    var cur=calY+'-'+String(calM).padStart(2,'0');
    if(!keys.some(function(k){return k.startsWith(cur);})){calY=+l[0];calM=+l[1];}
  }
  if(S._savedAt){
    var d=new Date(S._savedAt);
    document.getElementById('banner-txt').innerHTML+=
      ' Â· <span style="color:var(--MG)">'+(d.getMonth()+1)+'/'+d.getDate()+' '+d.getHours()+':'+String(d.getMinutes()).padStart(2,'0')+'</span>';
  }
  document.getElementById('chips').innerHTML=(S.teachers||[]).map(function(t){
    return '<button class="chip '+(t.type==='ë¹„ë‹´ì„'?'b':'')+'" onclick="pick(''+t.name+'')" id="chip-'+t.name+'">'+t.name+'</button>';
  }).join('');
}

/* íƒ­ ì „í™˜ */
function go(tab) {
  curTab = tab;
  document.getElementById('p-cal').style.display    = tab==='cal'    ? '':'none';
  document.getElementById('p-search').style.display = tab==='search' ? '':'none';
  document.getElementById('t-cal').classList.toggle('on',    tab==='cal');
  document.getElementById('t-search').classList.toggle('on', tab==='search');
  if(tab==='cal') renderCal();
}

/* ë‹¬ë ¥ */
function calMove(dir) {
  calM+=dir; if(calM>12){calM=1;calY++;} if(calM<1){calM=12;calY--;} renderCal();
}

function renderCal() {
  var titleEl=document.getElementById('cal-title');
  var bodyEl=document.getElementById('cal-body');
  var sumEl=document.getElementById('cal-sum');
  if(!titleEl||!S) return;
  titleEl.textContent=calY+'ë…„ '+calM+'ì›”';
  var asgns=S.assignments||{};
  var today=new Date(); today.setHours(0,0,0,0);
  var daysInMonth=new Date(calY,calM,0).getDate();
  var html='<div class="dow-row"><div class="dow-cell"></div>';
  ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'].forEach(function(h){html+='<div class="dow-cell">'+h+'</div>';});
  html+='</div>';
  var weeks=[], week=[];
  for(var d=1;d<=daysInMonth;d++){
    var dt=new Date(calY,calM-1,d), dow=dt.getDay();
    if(dow===0||dow===6) continue;
    if(dow===1&&week.length>0){weeks.push(week);week=[];}
    week.push(d);
  }
  if(week.length>0) weeks.push(week);
  var damCnt={}, bidamCnt={}, totalA=0;
  weeks.forEach(function(wk){
    var wStart=wk[0], wEnd=wk[wk.length-1];
    html+='<div class="week-row">';
    html+='<div class="week-label"><div class="wl-d">'+wStart+'</div><div class="wl-w">~'+wEnd+'</div></div>';
    for(var dow2=1;dow2<=5;dow2++){
      var dayOfMonth=wk.find(function(dd){return new Date(calY,calM-1,dd).getDay()===dow2;});
      if(dayOfMonth===undefined){html+='<div class="day-cell empty"></div>';continue;}
      var key=calY+'-'+String(calM).padStart(2,'0')+'-'+String(dayOfMonth).padStart(2,'0');
      var asgn=asgns[key];
      var dt2=new Date(calY,calM-1,dayOfMonth);
      var isToday=dt2.getTime()===today.getTime();
      var cellCls='day-cell'+(isToday?' today':'');
      var inner='<div class="day-num">'+dayOfMonth+(isToday?'<span class="today-dot"></span>':'')+'</div>';
      if(asgn==='off'){
        cellCls+=' off'; inner='<div class="off-label">íœ´ë¬´</div>';
      } else if(asgn&&typeof asgn==='object'){
        totalA++;
        if(asgn.dam){damCnt[asgn.dam]=(damCnt[asgn.dam]||0)+1;inner+='<div class="name-tag dam">'+asgn.dam+'</div>';}
        if(asgn.bidam){bidamCnt[asgn.bidam]=(bidamCnt[asgn.bidam]||0)+1;inner+='<div class="name-tag bidam">'+asgn.bidam+'</div>';}
      } else { cellCls+=' no-asgn'; }
      html+='<div class="'+cellCls+'">'+inner+'</div>';
    }
    html+='</div>';
  });
  bodyEl.innerHTML=html;
  if(totalA===0){sumEl.style.display='none';return;}
  sumEl.style.display='';
  var mk=function(n,c,t){return '<span class="sum-chip '+t+'">'+n+'<span>'+c+'íšŒ</span></span>';};
  var dE=Object.entries(damCnt).sort(function(a,b){return b[1]-a[1];});
  var bE=Object.entries(bidamCnt).sort(function(a,b){return b[1]-a[1];});
  sumEl.innerHTML=
    '<div class="sum-ttl">â–ª ë‹´ì„ ë°°ì • í˜„í™©</div><div class="sum-wrap">'+
    (dE.length?dE.map(function(e){return mk(e[0],e[1],'dam');}).join(''):'<span style="color:#ccc;font-size:11px">ì—†ìŒ</span>')+
    '</div><div class="sum-ttl">â–ª ë¹„ë‹´ì„ ë°°ì • í˜„í™©</div><div class="sum-wrap">'+
    (bE.length?bE.map(function(e){return mk(e[0],e[1],'bidam');}).join(''):'<span style="color:#ccc;font-size:11px">ì—†ìŒ</span>')+
    '</div>';
}

/* êµì‚¬ ì¡°íšŒ */
function pick(name){ document.getElementById('srch-inp').value=name; doSearch(); }

function doSearch(){
  var name=document.getElementById('srch-inp').value.trim();
  if(!name||!S) return;
  document.querySelectorAll('.chip').forEach(function(c){c.classList.toggle('on',c.textContent===name);});
  var t=(S.teachers||[]).find(function(t){return t.name===name;});
  if(!t){
    document.getElementById('res').innerHTML='<div class="empty"><div class="empty-ico">ğŸ¤”</div><p>''+name+'' ì„ ìƒë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>';
    return;
  }
  var today=new Date(); today.setHours(0,0,0,0);
  var my=[];
  Object.keys(S.assignments||{}).sort().forEach(function(key){
    var a=S.assignments[key];
    if(!a||typeof a!=='object') return;
    if(a.dam===name||a.bidam===name){
      var parts=key.split('-').map(Number), y=parts[0], m=parts[1], d=parts[2];
      var dt=new Date(y,m-1,d); dt.setHours(0,0,0,0);
      my.push({y:y,m:m,d:d,dt:dt,diff:Math.round((dt-today)/86400000)});
    }
  });
  var isB=t.type==='ë¹„ë‹´ì„';
  var nxt=my.filter(function(d){return d.diff>=0;}).sort(function(a,b){return a.diff-b.diff;})[0]||null;
  var byM={};
  my.forEach(function(d){
    var mk=d.y+'-'+String(d.m).padStart(2,'0');
    if(!byM[mk]) byM[mk]=[];
    byM[mk].push(d);
  });
  var h='<div class="t-card '+(isB?'b':'')+'"><div class="t-top">'+
    '<div class="ava '+(isB?'b':'')+'">'+t.name[0]+'</div>'+
    '<div class="t-info"><h2>'+t.name+' ì„ ìƒë‹˜</h2><p>'+t.type+(t.team?' Â· '+t.team+'íŒ€':'')+'</p></div>'+
    '<div class="t-cnt '+(isB?'b':'')+'">ì´ '+my.length+'íšŒ</div></div>';
  if(nxt){
    var ds=nxt.diff===0?'ì˜¤ëŠ˜!':nxt.diff===1?'ë‚´ì¼':'D-'+nxt.diff;
    h+='<div class="nxt '+(isB?'b':'')+'"><span style="font-size:18px">ğŸ“…</span>'+
      '<div class="nxt-txt">ë‹¤ìŒ ë“±êµì§€ë„<br><strong>'+nxt.m+'ì›” '+nxt.d+'ì¼ ('+DK[nxt.dt.getDay()]+')</strong></div>'+
      '<div class="nxt-dd">'+ds+'</div></div>';
  } else {
    h+='<div class="nxt" style="background:#f5f5f5"><span>âœ…</span><div class="nxt-txt" style="color:var(--MG)">ì´ë²ˆ ë°°ì • ê¸°ê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</div></div>';
  }
  Object.keys(byM).sort().forEach(function(mk){
    var parts=mk.split('-'), y=parts[0], m=parts[1];
    h+='<div class="m-sec"><div class="m-ttl">'+y+'ë…„ '+(+m)+'ì›”</div><div class="d-chips">';
    byM[mk].forEach(function(d){
      var cls=d.diff===0?'today':d.diff<0?'past':d.diff<=7?(isB?'bsoon':'soon'):'';
      h+='<div class="d-chip '+cls+'">'+d.m+'/'+d.d+'('+DK[d.dt.getDay()]+')</div>';
    });
    h+='</div></div>';
  });
  h+='</div>';
  document.getElementById('res').innerHTML=h;
}

</script>
</body>
</html>
